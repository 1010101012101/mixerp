<script src="/Scripts/inflection-js/inflection.js"></script>
<style>
    .kanban.container {
        overflow-y: hidden;
        overflow-x: auto;
    }


    .kanban.segments .ui.segment {
        max-width: 300px !important;
        min-height: 700px;
        padding: 8px;
    }

    .kanban .card {
        cursor: pointer;
    }

    .kanban.segments .ui.segment:nth-child(odd) {
        background-color: #FAFAFA !important;
    }

    .kanban.segments .ui.segment:nth-child(even) {
        background-color: #F9F9F9 !important;
    }

    .kanban.holder {
        height: 100%;
    }

    .card:hover {
        opacity: 0.75;
    }

    .unstyled.segment {
        border: none !important;
        box-shadow: none !important;
    }
</style>


<div class="view factory" style="display: none;">
    <div class="ui inverted active view dimmer">
        <div class="content">
            <div class="ui text loader">
                <span data-localize="Titles.Loading"></span>
            </div>
        </div>
    </div>
    <div id="VerificationPopUnder" class="ui initially hidden form popunder segment" style="width:400px;z-index:3; position: absolute;">
        <div class="ui header">
            <span data-localize="Titles.Verification"></span>
        </div>
        <div class="field">
            <label for="ReasonTextArea">
                <span data-localize="Titles.Reason"></span>
            </label>
            <textarea id="ReasonTextArea"></textarea>
        </div>
        <div class="ui buttons">
            <a id="ApproveButton" class="ui green button" href="javascript:void(0);">
                <span data-localize="Titles.Approve"></span>
            </a>
            <a id="RejectButton" class="ui orange button" href="javascript:void(0);">
                <span data-localize="Titles.Reject"></span>
            </a>

            <a href="javascript:void(0);" class="ui red button" onclick="$('#VerificationPopUnder').fadeOut(500);">
                <span data-localize="Titles.Close"></span>
            </a>
        </div>
    </div>

    <div id="FlagPopUnder" class="ui initially hidden form popunder segment" style="width:400px;z-index:3; position: absolute;">
        <div class="ui grey header">
            <span data-localize="Titles.CreateAFlag"></span>
        </div>
        <div>
            <span data-localize="Labels.FlagDescription"></span>
        </div>
        <p>
            <span data-localize="Labels.SelectAFlag"></span>
        </p>

        <select id="FlagSelect" class="ui fluid search dropdown selection"></select>

        <p class="ui buttons tpad8">
            <a href="javascript:void(0);" id="UpdateButton" class="green small ui button">
                <span data-localize="Titles.Update"></span>
            </a>

            <a href="javascript:void(0);" onclick="$('#FlagPopUnder').fadeOut(500);" class="red small ui button">
                <span data-localize="Titles.Close"></span>
            </a>
        </p>
    </div>

    <div id="FilterPopUnder" class="ui initially hidden form popunder segment" style="width:400px;z-index:3; position: absolute;">
        <div class="ui grey header">
            <span data-localize="Titles.SelectAFilter"></span>
        </div>
        <select class="ui fluid filter" id="DefaultFilterSelect"></select>
        <p class="ui action buttons tpad8">
            <a href="javascript:void(0);" onclick="$('#FilterPopUnder').fadeOut(500);" class="green small ui button" data-target="filter">
                <span data-localize="Titles.CreateNew"></span>
            </a>
            <a href="javascript:void(0);" onclick="$('#FilterPopUnder').fadeOut(500);" class="red small ui button">
                <span data-localize="Titles.Close"></span>
            </a>
        </p>
    </div>


    <div class="ui stackable grid">
        <div class="ui sixteen wide column">
            <div class="title ui huge grey header"></div>
            <div id="description" class="ui info description message" style="display: none;">
            </div>
        </div>
    </div>



    <script src="/Scripts/underscore/underscore-min.js"></script>


    <div id="KanbanForm" class="ui small modal">
        <i class="close icon"></i>
        <div class="ui grey header">
            <span data-localize="Titles.AddAKanbanList"></span>
        </div>
        <div class="content">
            <div class="ui form">
                <div class="field">
                    <label for="KanbanIdInputText">
                        <span data-localize="Titles.KanbanId"></span>
                    </label>
                    <input type="text" readonly id="KanbanIdInputText" />
                </div>
                <div class="field">
                    <label for="KanbanNameInputText">
                        <span data-localize="Titles.KanbanName"></span>
                    </label>
                    <input type="text" id="KanbanNameInputText" />
                </div>
                <div class="field">
                    <label for="KanbanDescriptionTextArea">
                        <span data-localize="Titles.Description"></span>
                    </label>
                    <textarea id="KanbanDescriptionTextArea"></textarea>
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui basic buttons">
                <div class="ui cancel button">
                    <span data-localize="Titles.Cancel"></span>
                </div>
                <a href="javascript:void(0);" class="ui button" onclick="saveOrUpdateKanban();">
                    <span data-localize="Titles.OK"></span>
                </a>
            </div>
        </div>
    </div>

    <div class="ui stackable grid">
        <div class="twelve wide column">
            <div class="ui basic buttons">
                <a id="AddNewButton" class="ui basic button" style="display: none;">
                    <span data-localize="Titles.AddNew"></span>
                </a>
                <a id="FlagButton" class="ui basic button">
                    <span data-localize="Titles.Flag"></span>
                </a>
                <a class="ui basic button" id="FilterButton">
                    <span data-localize="Titles.Filter"></span>
                </a>
                <div class="ui icon top left pointing dropdown basic button" id="ExportDropDown">
                    <span>
                        <span data-localize="Titles.Export"></span>
                    </span>
                    <div class="menu">
                        <div class="header">
                            <span data-localize="Titles.ExportThisDocument"></span>
                        </div>
                        <a class="item" href="javascript:void(0);" onclick="createDoc();">
                            <i class="file word outline blue icon"></i>
                            <span data-localize="Titles.ExportToDoc"></span>
                        </a>
                        <a class="item" href="javascript:void(0);" onclick="createXls();">
                            <i class="file excel outline green icon"></i>
                            <span data-localize="Titles.ExportToExcel"></span>
                        </a>
                        <a class="item" href="javascript:void(0);" onclick="createPDF();">
                            <i class="file pdf outline red icon"></i>
                            <span data-localize="Titles.ExportToPDF"></span>
                        </a>
                    </div>
                </div>
                <a id="PrintButton" href="javascript:void(0);" onclick="print()" class="ui basic button">
                    <span data-localize="Titles.Print"></span>
                </a>
            </div>
        </div>
        <div class="right aligned four wide column">
            <div class="ui small basic icon action buttons">
                <a class="ui basic button" data-target="import" title="Import">
                    <i class="upload layout icon"></i>
                </a>
                <a class="ui basic button" data-target="filter" title="Manage Filters">
                    <i class="icons">
                        <i class="filter layout icon"></i>
                        <i class="corner add icon"></i>
                    </i>
                </a>
                <a class="ui active basic button" data-target="kanban" title="Kanban View">
                    <i class="block layout icon"></i>
                </a>
                <a class="ui basic button" data-target="grid" title="Grid View">
                    <i class="grid layout icon"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="ui stackable form segment" ID="Annotation" style="display: none;">
        <div class="field">
            <div class="ui green button" id="ShowButton">Show</div>
        </div>
    </div>


    <div data-target="grid" style="display: none;">
        <div id="json" class="vpad8" style="width: 100%; overflow: auto;">
        </div>
    </div>

    <div data-target="kanban">
        <div class="kanban container">
            <div class="ui horizontal kanban segments" id="kanban" style="display: none;"></div>
        </div>
    </div>

    <div class="ui bottom hidden segment" data-target="filter">
        <div class="ui huge header">
            <span id="FilterName">
            </span>
        </div>
        <div class="ui divider"></div>

        <div class="ui stackable form" id="FilterForm">
            <div class="five fields">
                <div class="field">
                    <label for="ColumnSelect">
                        <span data-localize="Titles.SelectAColumn"></span>
                    </label>
                    <select class="ui search dropdown" id="ColumnSelect" required></select>
                </div>
                <div class="field">
                    <label for="FilterConditionSelect">
                        <span data-localize="Titles.FilterCondition"></span>
                    </label>
                    <select class="ui search dropdown" id="FilterConditionSelect" required></select>
                </div>
                <div class="field">
                    <label for="ValueInputText">
                        <span data-localize="Titles.Value"></span>
                    </label>
                    <input id="ValueInputText" required />
                </div>
                <div class="field">
                    <label for="AndInputText">
                        <span data-localize="Titles.And"></span>
                    </label>
                    <input id="AndInputText" readonly="readonly" />
                </div>
                <div class="field">
                    <label>&nbsp;</label>
                    <a href="javascript:void(0);" class="ui button" id="AddFilterButton">
                        <span data-localize="Titles.Add"></span>
                    </a>
                </div>
            </div>
        </div>

        <table class="ui striped table" id="FilterTable">
            <thead>
                <tr>
                    <th style="width: 100px;">
                        <span data-localize="Titles.Actions"></span>
                    </th>
                    <th>
                        <span data-localize="Titles.ColumnName"></span>
                    </th>
                    <th>
                        <span data-localize="Titles.Condition"></span>
                    </th>
                    <th>
                        <span data-localize="Titles.Value"></span>
                    </th>
                    <th>
                        <span data-localize="Titles.And"></span>
                    </th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="ui large header">
            <span data-localize="Titles.SaveThisFilter"></span>
        </div>
        <div class="ui divider"></div>
        <div class="ui form">
            <div class="fields">
                <div class="four wide field">
                    <label>
                        <span data-localize="Titles.FilterName"></span>
                    </label>
                    <input id="FilterNameInputText" />
                </div>
            </div>
            <div class="ui basic buttons">
                <div class="ui basic button" id="SaveFilterButton">
                    <span data-localize="Titles.Save"></span>
                </div>
                <div class="ui basic button" id="ManageFiltersButton">
                    <span data-localize="Titles.ManageFilters"></span>
                </div>
                <div class="ui basic button">
                    <span data-localize="Titles.Cancel"></span>
                </div>
            </div>
        </div>

        <div class="ui filter small modal">
            <i class="close icon"></i>
            <div class="ui huge header">
                <span data-localize="Titles.ManageFilters"></span>
            </div>
            <div class="content">
                <div class="ui form" style="max-width: 400px;">
                    <div class="field">
                        <label><span data-localize="Titles.SelectAFilter"></span></label>
                        <select class="ui search dropdown filter" id="FilterSelect"></select>
                    </div>
                    <div class="ui basic buttons">
                        <a class="ui close button" onclick="loadFilter();">
                            <span data-localize="Titles.Edit"></span>
                        </a>
                        <a class="ui close button" onclick="loadFilter();">
                            <span data-localize="Titles.Delete"></span>
                        </a>
                        <a class="ui close button">
                            <span data-localize="Titles.Close"></span>
                        </a>
                    </div>

                </div>
            </div>
            <div class="actions">
                <div class="ui basic buttons">
                    <a class="ui basic close button">
                        <span data-localize="Titles.RemoveAsDefault"></span>
                    </a>
                    <a class="ui basic button" id="MakeUserDefaultFilterButton">
                        <span data-localize="Titles.MakeAsDefault"></span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="ui hidden segment" data-target="import">
        <div class="ui huge header">
            <span data-localize="Titles.DataImport"></span>
        </div>

        <div class="ui basic buttons">
            <a class="ui basic button" id="DownloadTemplateButton">
                <span data-localize="Titles.ExportData"></span>
            </a>
            <div class="ui basic button">
                <label for="file">
                    <span data-localize="Titles.ImportData"></span>
                </label>
                <input type="file" id="file" style="display:none;">
            </div>
        </div>

        <div class="big error"></div>

        <div id="ProgressBar" class="vpad16" style="display:none;">
            <div data-percent="0" class="ui indicating progress active">
                <div style="transition-duration: 300ms; width: 0%;" class="bar"></div>
                <div class="label"></div>
            </div>
        </div>
    </div>



    <div class="ui load stackable grid unstyled segment" id="Pager">
        <div class="left aligned six wide column">
            <div class="ui breadcrumb">
                <a class="section current page anchor"></a>
                <div class="divider">/ </div>
                <a class="section total pages anchor"></a>
            </div>
        </div>
        <div class="right aligned ten wide column">
            <a class="ui left attached labeled icon button" onclick="showPreviousPage();">
                <i class="left arrow icon"></i>
                <span data-localize="Titles.Previous"></span>
            </a>
            <a class="ui right attached right labeled icon button" onclick="showNextPage();">
                <span data-localize="Titles.Next"></span>
                <i class="right arrow icon"></i>
            </a>
        </div>
    </div>












    <br />
    <script>
        var json;
        var kanbans;
        var scrudForm = $(".form.factory");
        var scrudView = $(".view.factory");
        var addNewButton = $("#AddNewButton");
        var viewReady = false;
        var metaDefinition;
        var falgDefinition;

        function canAdd() {
            window.scrudForm = $(".form.factory");

            if (window.scrudForm.length) {
                return true;
            };

            if (scrudFactory.addNewUrl) {
                addNewButton.attr("href", scrudFactory.addNewUrl);
                return true;
            };

            return false;
        };

        addNewButton.click(function () {
            if (window.scrudForm.length) {
                window.scrudView.hide();
                window.scrudForm.fadeIn(500);
                var url = updateQueryString("View", "FormView");
                window.history.pushState({ path: url }, '', url);
            };
        });


        if (!scrudFactory.card) {
            scrudFactory.card = new Object();
        };

        function checkIfProcedure() {
            if ((typeof (scrudFactory.isProcedure) === "undefined")) {
                return scrudFactory.viewAPI.indexOf("/procedures") !== -1;
            };

            return scrudFactory.isProcedure;
        };

    </script>

    <script>
        var columns = [];
        var filterConditions = [{ "value": "0", "text": "IsEqualTo" },
        { "value": "1", "text": "IsNotEqualTo" },
        { "value": "2", "text": "IsLessThan" },
        { "value": "3", "text": "IsLessThanEqualTo" },
        { "value": "4", "text": "IsGreaterThan" },
        { "value": "5", "text": "IsGreaterThanEqualTo" },
        { "value": "6", "text": "IsBetween" },
        { "value": "7", "text": "IsNotBetween" },
        { "value": "8", "text": "IsLike" },
        { "value": "9", "text": "IsNotLike" }];

        $("#FilterName").text(Resources.Titles.Untitled());
    </script>
    <script>
        function tryParseLocalizedResource(text) {
            var localized = executeFunctionByName("Resources.Titles." + text, window);

            if (!localized) {
                var underscoreCase = toUnderscoreCase(text);
                localized = executeFunctionByName("Resources.ScrudResource." + underscoreCase, window);
            };

            if (localized) {
                return localized;
            };

            return text;
        };

        function toUnderscoreCase(str) {
            return str.replace(/(?:^|\.?)([A-Z])/g, function (x, y) { return "_" + y.toLowerCase() }).replace(/^_/, "");
        };

        function localizeHeaders(el) {
            el.find("thead tr th").each(function () {
                var cell = $(this);
                var text = tryParseLocalizedResource(cell.text());
                cell.text(text);

                var column = new Object();
                column.name = name;
                column.text = text;

                columns.push(column);
            });
        };
    </script>
    <script>
        function createGridView(appendTo, json) {
            appendTo.html("");

            if (isNullOrWhiteSpace(json || "")) {
                return null;
            };
            var excludedColumnIndices = [];

            if (!json) {
                return null;
            };

            var el = $('<table class="ui striped nowrap scrudview table" id="ScrudView">');
            var header = "<thead><tr>";

            var index = 0;

            if (!scrudFactory.excludedColumns) {
                scrudFactory.excludedColumns = [];
            };

            $.each(json[0], function (name) {
                if (scrudFactory.excludedColumns.indexOf(name) === -1) {
                    header += "<th>" + name + "</th>";
                } else {
                    excludedColumnIndices.push(index);
                };

                index++;
            });

            header += "</tr></thead>";

            $(header).appendTo(el);

            var body = $("<tbody />");

            $.each(json, function (i, value) {
                var row = "<tr>";

                index = 0;
                $.each(value, function (key, val) {
                    if (excludedColumnIndices.indexOf(index) === -1) {
                        var title = "";
                        if (val === false) {
                            val = Resources.Titles.No();
                        };

                        if (val === true) {
                            val = Resources.Titles.Yes();
                        };

                        var column = Enumerable.From(metaDefinition.Columns)
                            .Where(function (x) { return x.PropertyName === key }).ToArray()[0];

                        if (column) {
                            var dataType = column.DbDataType;

                            if (dataType === "date") {
                                if (val == null) {
                                    val = "";
                                };

                                title = ' title ="' + val.toFormattedDate() + '"';
                                var d = new Date(removeTimezone(val));
                                val = moment(d).fromNow();
                            };

                            if (dataType === "time") {
                                val = getTime(val);
                            };
                        };

                        row += stringFormat("<td{0}>{1}</td>", title, (val || ""));
                    };

                    index++;
                });

                row += "</tr>";

                body.append(row);
            });

            $(el).append(body);
            $(appendTo).append(el);
        };

    </script>
    <script>
        //Utilities
        function getPageNumber() {
            var page = parseInt(getQueryStringByName("Page") || 0);
            var totalPage = parseInt($(".total.pages.anchor:first").text() || 1);

            if (!page) {
                return 1;
            };

            if (page > totalPage) {
                page = totalPage;
            };

            return page;
        };

        function getFilter() {
            if ($("#DefaultFilterSelect").val()) {
                var filter = $("#DefaultFilterSelect").getSelectedValue();
                return filter;
            };

            return "";
        };


        function bindSelect(el, data, valueField, textField) {
            $.each(data, function () {
                var option = "<option value='" + this[valueField] + "'>" + this[textField] + "</option>";
                el.append(option);
            });
        };
    </script>
    <script>
        function loadPageCount(callback) {
            $(".view.dimmer").addClass("active");

            if (checkIfProcedure()) {
                if (typeof callback === "function") {
                    callback();
                };

                return;
            };

            var filterName = getFilter();

            var countTotalItemsAjax = countTotalItems(filterName, false);

            countTotalItemsAjax.success(function (msg) {
                var pages = (Math.ceil(parseInt(msg) / 10) || 1);

                $(".total.pages.anchor").text(pages);

                if (typeof callback === "function") {
                    callback();
                };
            });

            countTotalItemsAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });

        };

        function countTotalItems(filterName) {
            if (getFilterQueryStringCount()) {
                var qs = getQueryStrings();
                return getFilteredTotalPages(qs);
            };

            var url = scrudFactory.viewAPI + "/count";

            if (filterName) {
                url = scrudFactory.viewAPI + "/count-filtered/" + filterName;
            };

            return getAjaxRequest(url);
        };

        function getAjaxFilters(queryStrings) {
            var filters = [];

            $.each(queryStrings, function (index, value) {
                filters.push(getAjaxColumnFilter("WHERE", toUnderscoreCase(value.key), 0, value.value));
            });

            return filters;
        };

        function getFilteredTotalPages(queryStrings) {
            var filters = getAjaxFilters(queryStrings);

            var url = scrudFactory.viewAPI + "/count-where";
            var data = JSON.stringify(filters);

            return getAjaxRequest(url, "POST", data);
        };


    </script>
    <script>
        function loadFilterConditions() {
            var el = $("#FilterConditionSelect");
            bindSelect(el, filterConditions, "value", "text");
            el.dropdown();
        };

        function loadColumns() {
            var el = $("#ColumnSelect");
            el.html("");
            bindSelect(el, columns, "name", "text");
            el.dropdown();
        };

        $("#FilterNameInputText").keyup(function () {
            $("#FilterName").html(Resources.Titles.Untitled());
            if ($(this).val()) {
                var filterName = stringFormat(window.Resources.Labels.NamedFilter(), $(this).val());
                $("#FilterName").html(filterName);
            };
        });

        function loadFilter() {
            var filterName = $("#FilterSelect").getSelectedText();
            $("#FilterName").html(filterName);
            $("#FilterNameInputText").val(filterName);
            var getFiltersAjax = getFilters(filterName);

            getFiltersAjax.success(function (msg) {
                createFilters(msg);
                $('.filter.modal').modal('hide');
            });

            getFiltersAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });
        };

        function getFilters(filterName) {
            var url = "/api/core/filter/get-where/1";
            var where = [];

            where.push(getAjaxColumnFilter("WHERE", "object_name", FilterConditions.IsEqualTo, scrudFactory.viewTableName));
            where.push(getAjaxColumnFilter("AND", "filter_name", FilterConditions.IsEqualTo, filterName));

            var data = JSON.stringify(where);

            return getAjaxRequest(url, "POST", data, true);
        };
    </script>
    <script>
        function loadFilterNames() {
            var getFilterNamesAjax = getFilterNames();

            getFilterNamesAjax.success(function (data) {
                var selected = "";

                var option = "<option value=''>";
                option += window.Resources.Titles.SelectAFilter();
                option += "</option>";

                $.each(data, function () {
                    var isDefault = this.IsDefault;

                    if (isDefault) {
                        selected = this.FilterName;
                    };

                    option += stringFormat("<option value='{0}'>{0}</option>", this.FilterName);
                });


                $("#DefaultFilterSelect").html(option);

                if (selected) {
                    $("#DefaultFilterSelect").dropdown({ placeholder: false }).dropdown("set selected", selected);
                    loadPageCount(loadGrid);
                } else {
                    $("#DefaultFilterSelect").dropdown({ placeholder: false });
                    loadPageCount(loadGrid);
                };

                $("#FilterSelect").html(option).dropdown();


                $("#DefaultFilterSelect").change(function () {
                    loadPageCount(loadGrid);
                });
            });
        };

        function getFilterNames() {
            var url = "/api/core/filter-name-view/get-where/1";
            var where = [];

            where.push(getAjaxColumnFilter("WHERE", "object_name", FilterConditions.IsEqualTo, scrudFactory.viewTableName));
            var data = JSON.stringify(where);

            return getAjaxRequest(url, "POST", data, false);
        };
    </script>
    <script>
        //Annotation
        function getAnnotation() {
            var els = $("#Annotation .fields .field .data-member");

            var annotation = new Object();

            els.each(function () {
                var el = $(this);
                var key = el.attr("data-model");
                var value = el.val();

                annotation[key] = value;
            });

            return annotation;
        };

        function loadAnnotation() {
            function request() {
                var url = scrudFactory.viewAPI + "/annotation";
                return getAjaxRequest(url);
            };

            if (!checkIfProcedure()) {
                return;
            };

            var ajax = request();
            ajax.success(function (msg) {
                createAnnotationFields(msg);
            });
        };

        function createAnnotationFields(annotation) {
            $.each(annotation.Columns, function (i, v) {
                if (scrudFactory.hiddenAnnotation) {
                    var isHidden = Enumerable.From(scrudFactory.hiddenAnnotation).Where(function (x) { return x === v.PropertyName; }).Count() === 1;
                    annotation.Columns[i].IsHidden = isHidden;
                };
            });

            var visible = Enumerable.From(annotation.Columns).Where(function (x) { return !x.IsHidden; }).ToArray();
            var groups = window.chunk_array(visible, 6);

            var fields;

            $.each(groups, function (i, group) {
                fields = $('<div class="six fields" />');

                $.each(group, function (i, item) {
                    addAnnotationField(item, fields);
                });

                $("#ShowButton").parent().before(fields);
            });

            var hidden = Enumerable.From(annotation.Columns).Where(function (x) { return x.IsHidden; }).ToArray();

            $.each(hidden, function (i, item) {
                addAnnotationField(item, fields, true);
            });


            $("#ShowButton").parent().before(fields);
            $("#ShowButton").parent().insertAfter($("#Annotation .fields").last().find(".field").last());

            setRegionalFormat();
            loadDatepicker();
            $("#Annotation").fadeIn();
            executeFunction();
        };

        $("#ShowButton").click(function () {
            executeFunction();
        });

        function simplifyAnnotationType(dbType) {
            var type = dbType.toString().toLowerCase();

            if (type === "text") {
                type = "string";
            };

            return type;
        };

        function addAnnotationField(item, fields, hidden) {
            var field = $('<div class="field" />');

            var type = simplifyAnnotationType(item.DbDataType);

            var el = getField(item.PropertyName, type, true);
            el.attr("placeholder", item.PropertyName);

            if (scrudFactory.defaultAnnotation) {
                var defaultValue = Enumerable.From(scrudFactory.defaultAnnotation).Where(function (x) { return x.key === item.PropertyName; }).FirstOrDefault();
                var queryValue = getQueryStringByName("Annotation" + item.PropertyName);

                if (queryValue) {
                    defaultValue.value = queryValue;
                };

                if (defaultValue) {
                    el.val(defaultValue.value);
                };
            };

            el.addClass("data-member");
            el.attr("id", "Annotation" + item.PropertyName);
            el.attr("title", item.PropertyName);
            el.attr("data-model", item.PropertyName);

            if (hidden) {
                field.addClass("hidden");
            };

            field.append(el);
            fields.append(field);
        };

        function executeFunction() {
            function request(annotation) {
                var url = scrudFactory.viewAPI + "/execute";
                var data = JSON.stringify(annotation);

                return getAjaxRequest(url, "POST", data);
            };

            var annotation = getAnnotation();
            var ajax = request(annotation);

            ajax.success(function (response) {
                onViewSuccess(response);
            });
        };


        //Todo: Merge this function with formfactory
        function getField(propertyName, dataType, nullable) {
            if (typeof (scrudFactory.keys) === "undefined") {
                scrudFactory.keys = [];
            };

            var hasKey = Enumerable.From(scrudFactory.keys || [])
                .Where(function (x) { return x.property === propertyName }).ToArray()[0];

            if (hasKey) {
                return $("<select class='ui search fluid dropdown' />");
            };

            switch (dataType) {
                case "image":
                    return $("<input type='text' class='image' />");
                case "int4":
                case "int8":
                case "integer_strict":
                case "integer_strict2":
                    return $("<input type='text' class='integer' />");
                case "float8":
                case "decimal":
                case "decimal_strict":
                case "numeric":
                    return $("<input type='text' class='decimal' />");
                case "money_strict2":
                case "money_strict":
                    return $("<input type='text' class='currency' />");
                case "text":
                    return $("<textarea />");
                case "date":
                    return $("<input type='text' class='date' />");
                case "bool":
                    var el = $("<select class='ui search dropdown' />");
                    var option = "<option";

                    if (nullable) {
                        option += " value='Select'>";
                    } else {
                        option += " value=''>";
                    };

                    option += Resources.Titles.Select() + "</option>";
                    option += "<option value='yes'>" + Resources.Titles.Yes() + "</option>";
                    option += "<option value='no'>" + Resources.Titles.No() + "</option>";

                    el.append(option);

                    return el;
                default:
                    return $("<input type='text' />");
            };
        };

    </script>
    <script>
    function createCards() {
        function getKanbanDetails(kanbanIds, resourceIds) {
            var url = "/api/core/kanban-detail/get-by-resources/";
            url += "?kanbanIds=";
            url += kanbanIds.join("&kanbanIds=");

            url += "&resourceIds=";
            url += resourceIds.join("&resourceIds=");

            return getAjaxRequest(url);
        };

        if (!window.json) {
            return;
        };

        if (!window.kanbans) {
            return;
        };

        var keyField = (scrudFactory.card.keyField || getIdField());
        var resourceIds = Enumerable.From(window.json).Select(function (x) { return x[keyField]; }).ToArray();
        var kanbanIds = Enumerable.From(window.kanbans).Select(function (x) { return x.KanbanId; }).ToArray();

        var getKanbanDetailsAjax = getKanbanDetails(kanbanIds, resourceIds);

        getKanbanDetailsAjax.success(function (msg) {
            $(".kanban.holder").html("");

            $.each(window.json, function (i, v) {
                var key = getCardKey(v);
                var kanbanDetail = (Enumerable.From(msg).Where(function (detail) { return detail.ResourceId.toString() === key.toString() }).ToArray()[0] || new Object());
                createCard(v, key, kanbanDetail);
            });

            makeSortable();
            makeRatable();
            displayFlaggedCards();
        });

    };

    function makeSortable() {
        $(function () {
            $("#kanban .segment .kanban.holder").sortable({
                connectWith: "#kanban .segment .kanban.holder",
                receive: function (event, ui) {
                    var card = $(ui.item[0]);

                    var kanbanDetail = new Object();
                    kanbanDetail.KanbanDetailId = (card.attr("data-kanban-detail-id") || 0);
                    kanbanDetail.KanbanId = parseInt(card.parent().parent().attr("id").replace("kanban", "") || 0);
                    kanbanDetail.Rating = card.find(".rating .active.icon").length;
                    kanbanDetail.ResourceId = card.attr("data-key");

                    if (kanbanDetail.KanbanId) {
                        var addOrEditKanbanDetailAjax = addOrEditKanbanDetail(kanbanDetail);

                        addOrEditKanbanDetailAjax.success(function (msg) {
                            card.attr("data-kanban-detail-id", msg);
                        });
                    } else {
                        if (kanbanDetail.KanbanDetailId) {
                            var deleteKanbanDetailAjax = deleteKanbanDetail(kanbanDetail.KanbanDetailId);

                            deleteKanbanDetailAjax.success(function () {
                                card.removeAttr("data-kanban-detail-id");
                            });
                        };
                    };

                }
            }).disableSelection();
        });
    };

    function makeRatable() {
        $('.ui.rating').rating();

        function updateRating(kanbanDetail) {
            var url = "/api/core/kanban-detail/add-or-edit";

            var form = [];
            form.push(kanbanDetail);
            form.push(null);

            var data = JSON.stringify(form);

            return getAjaxRequest(url, "PUT", data);
        };

        $('.ui.rating i').dblclick(function () {
            var el = $(this);
            var card = el.parent().parent().parent();
            var kanbanDetailId = card.attr("data-kanban-detail-id");

            if (kanbanDetailId) {

                var kanbanDetail = new Object();
                kanbanDetail.KanbanDetailId = kanbanDetailId;
                kanbanDetail.KanbanId = card.closest(".segment").attr("id").replace("kanban", "");
                kanbanDetail.ResourceId = card.attr("data-key");
                kanbanDetail.Rating = el.parent().find("i.active").length;

                updateRating(kanbanDetail);
            };
        });
    };

    function deleteKanbanDetail(kanbanDetailId) {
        var url = "/api/core/kanban-detail/delete/" + kanbanDetailId;

        return getAjaxRequest(url, "DELETE");
    };

    function addOrEditKanbanDetail(kanbanDetail) {
        var url = "/api/core/kanban-detail/add-or-edit";

        var form = [];
        form.push(kanbanDetail);
        form.push(null);

        var data = JSON.stringify(form);

        return getAjaxRequest(url, "PUT", data);
    };

    function getExtraContent(key) {
        var extraContent = $('<div class="extra center content" />');

        var buttons = $('<div class="ui small basic buttons" />');

        if (scrudFactory.viewUrl) {
            var url = scrudFactory.viewUrl.replace("{Key}", key);
            var viewButton = $('<a class="ui basic button" />');
            viewButton.attr("href", url);
            viewButton.text(Resources.Titles.View());
            buttons.append(viewButton);
        };

        if (scrudFactory.allowEdit) {
            var editButton = $('<a class="ui basic button" href="javascript:void(0);" onclick="editRow(this, true);" />');
            editButton.text(Resources.Titles.Edit());
            buttons.append(editButton);
        }

        if (scrudFactory.allowDelete) {
            var deleteButton = $('<a class="ui basic button" href="javascript:void(0);" onclick="deleteRow(this, true);" />');
            deleteButton.text(Resources.Titles.Delete());
            buttons.append(deleteButton);
        };


        extraContent.append(buttons);

        return extraContent;
    };

    function getExtra(kanbanDetail) {
        var extra = $('<div class="extra" />');

        var text = $("<span />");
        text.text(Resources.Titles.Rating());
        extra.append(text);

        var dataRating = (kanbanDetail.Rating || 0);

        var rating = $('<div class="ui star rating" data-max-rating="5" />');
        rating.attr("data-rating", dataRating);

        extra.append(rating);


        return extra;
    };

    function getClassName() {
        if (scrudFactory.className) {
            return scrudFactory.className;
        };

        var table = scrudFactory.formTableName;

        if (!table) {
            table = scrudFactory.viewTableName;
        }

        var plural = toProperCase(table.split(".")[1]);
        return plural.singularize();
    };

    function getQualified(dynamic, prefix, suffixes) {
        var qualified = "";

        $.each(suffixes, function (i, v) {
            if (!qualified) {
                var candidate = prefix + v;

                if (dynamic.hasOwnProperty(candidate)) {
                    qualified = candidate;
                    return false;
                };
            };
        });

        return qualified;
    };

    var candidates = {
        primary: ["Code", "Number", "Name"],
        secondary: [
            "Party", "PartyName", "Item", "ItemName",
            "NoticeDate", "ApprovedOn", "Reason", "Employee",
            "EmployeeName", "EmployeeCode", "Office", "CurrencyCode"
        ]
    };

    function getHeaderField(dynamic) {
        var className = getClassName();

        var primary = candidates.primary;
        var qualified = getQualified(dynamic, className, primary);

        if (!qualified) {
            var secondary = candidates.secondary;

            qualified = getQualified(dynamic, "", secondary);
        };

        return qualified;
    };

    function getMetaField(dynamic, headerField) {
        var className = getClassName();

        var primary = Enumerable.From(candidates.primary)
            .Where(function (x) { return x !== headerField.replace(className, "") })
            .ToArray();

        var qualified = getQualified(dynamic, className, primary);

        if (!qualified) {
            var secondary = Enumerable.From(candidates.secondary)
                .Where(function (x) { return x !== headerField })
                .ToArray();

            qualified = getQualified(dynamic, "", secondary);
        };

        return qualified;
    };

    function getIdField() {
        var className = getClassName();
        return className + "Id";
    };

    function getCardKey(dynamic) {
        var keyField = (scrudFactory.card.keyField || getIdField());
        return dynamic[keyField];
    };

    function getImageField(entity) {
        var imageField;

        $.each(entity, function (i) {
            if (!imageField) {
                if (i.toLowerCase().indexOf("image") !== -1) {
                    imageField = i;
                };
            };

            if (!imageField) {
                if (i.toLowerCase().indexOf("photo") !== -1) {
                    imageField = i;
                };
            };
        });

        return imageField;
    };

    function getDescriptionField(entity) {
        var candidates = ["Email", "Url", "City", "Phone", "CompanyName", "Currency"];
        return getQualified(entity, "", candidates);
    };

    function getCardField(card, field) {
        var isExpression = field.substring(2, 0) === "{{" && field.slice(-2) === "}}";
        if (isExpression) {
            var expression = field.replace("{{", "").replace("}}", "");
            return eval(expression);
        };

        return card[field];
    };

    function createCard(dynamic, key, kanbanDetail) {
        var kanbanId = (kanbanDetail.KanbanId || 0);

        var text;
        var imageField = (scrudFactory.card.image || getImageField(dynamic));
        var headerField = (scrudFactory.card.header || getHeaderField(dynamic));
        var metaField = (scrudFactory.card.meta || getMetaField(dynamic, headerField));
        var descriptionField = (scrudFactory.card.description || getDescriptionField(dynamic));

        var card = $('<div class="ui card" />');
        card.attr("data-kanban-detail-id", kanbanDetail.KanbanDetailId);
        card.attr("data-key", key);


        if (imageField) {
            var src = getCardField(dynamic, imageField);
            if (src) {
                var image = $('<div class="image" />');
                var img = $("<img />");
                img.attr("src", "/api/core/attachment/document/300/250/" + src);

                image.append(img);
                card.append(image);
            };
        };

        var content = $('<div class="content" />');

        var checkbox = $('<div class="ui toggle checkbox" />');
        var input = $('<input name="public" type="checkbox">');

        checkbox.append(input);

        content.append(checkbox);

        if (headerField) {
            text = getCardField(dynamic, headerField);
            if (text) {
                var header = $('<div class="header" />');

                header.text(text);
                content.append(header);
            };
        };

        if (metaField) {
            text = getCardField(dynamic, metaField);
            if (text) {
                var meta = $('<div class="meta" />');

                meta.text(text);
                content.append(meta);
            };
        };

        if (descriptionField) {
            text = getCardField(dynamic, descriptionField);
            if (text) {
                var description = $('<div class="meta" />');

                description.text(text);
                content.append(description);
            };
        };

        card.append(content);
        card.append(getExtraContent(key));
        card.append(getExtra(kanbanDetail));

        $("#kanban" + kanbanId + " .kanban.holder").append(card);
        $(".checkbox").checkbox();
    };




    $("#ApproveButton").click(function () {
        var primaryKey = getPrimaryKeyValue();

        if (!hasVerfication() || !primaryKey) {
            return;
        };

        var reason = reasonTextArea.val();
        var verificationStatusId = 2; //2 -> Approved, -3 -> Rejected

        var verifyAjax = verify(primaryKey, verificationStatusId, reason);

        verifyAjax.success(function () {
            displayMessage(Resources.Labels.TaskCompletedSuccessfully(), "success");
        });
    });

    $("#RejectButton").click(function () {
        var primaryKey = getPrimaryKeyValue();

        if (!hasVerfication() || !primaryKey) {
            return;
        };

        var reason = reasonTextArea.val();
        var verificationStatusId = -3; //2 -> Approved, -3 -> Rejected

        var verifyAjax = verify(primaryKey, verificationStatusId, reason);

        verifyAjax.success(function () {
            displayMessage(Resources.Labels.TaskCompletedSuccessfully(), "success");
        });
    });

    function verify(primaryKey, verificationStatusId, reason) {
        var url = scrudFactory.formAPI;
        url += "/verify/";
        url += primaryKey + "/";
        url += verificationStatusId + "/";
        url += reason;

        return getAjaxRequest(url, "PUT");
    };
    </script>

    <script>
        function showTarget(target) {
            $("div[data-target]").hide();
            var targetEl = $('div[data-target="' + target.toLowerCase() + '"]');
            targetEl.removeClass("hidden").fadeIn(500);

            $('a[data-target]').removeClass("active");
            $('a[data-target="' + target + '"]').addClass("active");
        };

        function initializeViews() {
            if (scrudFactory.removeKanban || checkIfProcedure()) {
                $('[data-target="kanban"]').remove();
                showTarget("grid");
            };

            if (scrudFactory.removeFilter || checkIfProcedure()) {
                $('[data-target="filter"]').remove();
                $("#FilterButton").remove();
                showTarget("grid");
            };

            if (scrudFactory.removeImport || checkIfProcedure()) {
                $('[data-target="import"]').remove();
                showTarget("grid");
                $('a[data-target="grid"]').remove();
            };
        };

        function initializeCustomButtons() {
            if (!scrudFactory.customButtons) {
                return;
            };

            var buttons = scrudFactory.customButtons;

            $.each(buttons, function (i, v) {
                var anchor = $("<a class='ui basic button' />");

                if (v.id) {
                    anchor.attr("id", v.id);
                };

                if (v.text) {
                    anchor.text(v.text);
                };

                if (v.href) {
                    anchor.attr("href", v.href);
                };

                if (v.onclick) {
                    anchor.attr("onclick", v.onclick);
                };

                $("#FlagButton").before(anchor);
            });


        };

        function hasVerfication() {
            if (!scrudFactory.hasVerfication) {
                return false;
            };

            if (!scrudFactory.formAPI) {
                return false;
            };

            var candidates = ["verification_status_id", "verification_reason"];

            var columns = Enumerable.From(metaDefinition.Columns).Select(function (x) { return x.ColumnName.toString() }).ToArray();
            var result = Enumerable.From(candidates).Except(columns).ToArray();
            return result.length === 0;
        };

        function createVerificationButton() {
            if (!hasVerfication()) {
                return;
            };

            var anchor = $("<a href='javascript:void(0);' id='VerifyButton' class='ui basic button' />");
            anchor.html(window.Resources.Titles.Verify());

            anchor.insertAfter(flagButton);

            var verifyButton = $("#VerifyButton");

            verifyButton.click(function () {
                popUnder(verificationPopUnder, verifyButton);
            });
        };

        function getActions(actions) {
            if (!actions.length) {
                return "";
            };

            var els = $("<div />");

            $.each(actions, function (i, v) {
                var anchor = $("<a />");
                var href = "javascript:void(0);";//Without href, anchors do not interact with keyboard events such as spacebar or return key.

                if (v.title) {
                    anchor.attr("title", v.title);
                };

                if (v.href) {
                    href = v.href;
                };

                anchor.attr("href", href);

                if (v.onclick) {
                    anchor.attr("onclick", v.onclick);
                };

                if (v.icon) {
                    var icon = $("<i />");
                    icon.addClass(v.icon);
                    anchor.append(icon);
                };

                els.append(anchor);
            });

            return els.html();
        };

        function loadActions() {
            var deleteTemplate = "";
            var editTemplate = "";

            if (scrudFactory.allowDelete) {
                deleteTemplate = stringFormat("<a onclick='deleteRow(this);' title='{0}'><i class='delete icon'></i></a>", Resources.Titles.Delete());
            };

            if (scrudFactory.allowEdit) {
                editTemplate = stringFormat("<a onclick='editRow(this);' title='{0}'><i class='edit icon'></i></a>", Resources.Titles.Edit());
            };

            var grid = $(".scrudview.table");

            var actionCount = (!isNullOrWhiteSpace(editTemplate) + !isNullOrWhiteSpace(deleteTemplate));

            if (scrudFactory.customActions) {
                actionCount += scrudFactory.customActions.length;
            };


            var header = stringFormat("<th style='width:{0}px;'>{1}</th>", actionCount * 25, Resources.Titles.Actions());
            header += "<th class='action' style='cursor:pointer;'>" + Resources.Titles.Select() + "</th>";
            var selectTemplate = '<div class="ui toggle checkbox"> \
                                      <input type="checkbox">\
                                      <label></label>\
                                    </div>';

            var actions = editTemplate + deleteTemplate;

            if (scrudFactory.customActions) {
                var preActions = Enumerable.From(scrudFactory.customActions).Where(function (x) { return x.position === "before"; }).ToArray();
                var postActions = Enumerable.From(scrudFactory.customActions).Where(function (x) { return x.position !== "before"; }).ToArray();

                actions = getActions(preActions) + actions + getActions(postActions);
            };



            var actionTemplate = stringFormat("<td>{0}</td><td>{1}</td>", actions, selectTemplate);

            grid.find("th:first-child").before(header);


            grid.find("tbody tr").each(function () {
                var el = $(this);
                var vallue = el.find("td:first-child").html();
                el.find("td:first-child").before(actionTemplate.replace(/{id}/g, vallue));
            });

            $(".scrudview.table tr").click(function (sender) {
                var row = $(this);
                var cell = $(sender.target).closest('td');

                if (cell.index() > 1) {
                    var el = row.find("input:checkbox");
                    toogleSelection(el);
                };
            });

            var isSelectionToggler = true;

            $("th.action").click(function () {
                if (isSelectionToggler) {
                    $(".scrudview.table input:checkbox").prop("checked", "checked");
                }
                else {
                    $(".scrudview.table input:checkbox").removeProp("checked");
                };

                isSelectionToggler = !isSelectionToggler;
            });
        };

        $(document).ready(function () {
            window.scrudForm = $(".form.factory");
            window.scrudView = $(".view.factory");

            var defaultView = window.getQueryStringByName("View");

            if ((defaultView || "") === "FormView") {
                scrudView.hide();
            };


            loadMeta(loadFilterNames);
            loadFilterConditions();
            $("#ExportDropDown").dropdown();

            if (scrudFactory.title) {
                $(".title").html(scrudFactory.title);
            };
            if (scrudFactory.description) {
                $("#description").html(scrudFactory.description).show();
            } else {
                $("#description").remove();
            };

            if (typeof (scrudFactory.back) === "object") {
                var title = scrudFactory.back.Title;
                var url = scrudFactory.back.Url;

                var anchor = $("<a/>");
                anchor.addClass("ui basic button");
                anchor.attr("title", Resources.Titles.Back());
                anchor.attr("href", url);
                anchor.text(title);

                $("#AddNewButton").before(anchor);
            };

            initializeViews();
            initializeCustomButtons();
        });

        function loadMeta(callback) {
            var getMetaAjax = getMeta();

            getMetaAjax.success(function (msg) {
                metaDefinition = msg;
                if (typeof (callback) === "function") {
                    callback();
                }
            });
        };


        function loadGrid() {
            var pageNumber = getPageNumber();
            var filterName = getFilter();

            if (checkIfProcedure()) {
                $(".view.dimmer").removeClass("active");
                $("#Pager").remove();
                loadAnnotation();
                return;
            };

            $(".current.page.anchor").text(pageNumber);
            var getViewAjax = getView(pageNumber, filterName, false);

            getViewAjax.success(function (response) {
                onViewSuccess(response);
            });

            getViewAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });
        };

        function onViewSuccess(response) {
            window.json = response;
            var el = $("#json");
            createGridView(el, window.json);
            localizeHeaders(el);
            loadColumns();
            loadActions();
            loadButtons();
            triggerViewReadyEvent();
            $(".view.dimmer").removeClass("active");
            createCards();
            $(".view.factory").fadeIn();
        };

        function triggerViewReadyEvent() {
            if (!window.viewReady) {
                window.viewReady = true;
                $(document).trigger("viewready");
            };
        };

        function getFilterQueryStringCount() {
            var qs = getQueryStrings();
            var ignoredQueryStrings = ["View", "Page"];
            var count = Enumerable.From(qs).Where(function (s) { return ignoredQueryStrings.indexOf(s.key) === -1; }).ToArray().length;

            return count;
        };

        function loadButtons() {
            if (canAdd()) {
                addNewButton.show();
            } else {
                addNewButton.remove();
            };

            createVerificationButton();
        };

        function getView(pageNumber, filterName, byOffice) {
            if (getFilterQueryStringCount()) {
                var qs = getQueryStrings();
                return getFilteredView(pageNumber, qs, byOffice);
            };

            var url = scrudFactory.viewAPI + "/page/" + pageNumber;

            if (filterName) {
                url = scrudFactory.viewAPI + "/get-filtered/" + pageNumber + "/" + filterName;
            };

            return getAjaxRequest(url);
        };

        function getFilteredView(pageNumber, queryStrings) {
            var url = scrudFactory.viewAPI + "/get-where/" + pageNumber;
            data = JSON.stringify(getAjaxFilters(queryStrings));
            return getAjaxRequest(url, "POST", data);
        };

        function getMeta() {
            var api = scrudFactory.formAPI;

            if (typeof (api) === "undefined") {
                api = scrudFactory.viewAPI;
            };

            var url = api + "/meta";
            return getAjaxRequest(url);
        };
    </script>
    <script>
        var columnSelect = $("#ColumnSelect");
        var filterConditionSelect = $("#FilterConditionSelect");
        var valueInputText = $("#ValueInputText");
        var andInputText = $("#AndInputText");
        var commandItems = "<a onclick='deleteFilter(this);'><i class='delete icon'></i></a><a onclick='editFilter(this);'><i class='edit icon'></i></a><a onclick='$(this).parent().parent().toggleClass(\"warning\");'><i class='check mark icon'></i></a>";

        filterConditionSelect.change(function () {
            var val = parseFloat(filterConditionSelect.val() || 0);

            if (val >= 6 && val <= 7) {
                andInputText.removeAttr("readonly");
                return;
            };

            andInputText.attr("readonly", "readonly");
            andInputText.val("");
        });

        function validateFilters() {
            var isValid = true;

            $("#FilterForm [required]").each(function () {
                var el = $(this);

                if (isNullOrWhiteSpace(el.val())) {
                    isValid = false;
                    makeDirty(el);
                    return;
                };

                removeDirty(el);
            });

            return isValid;
        };


        $("#AddFilterButton").click(function () {
            var grid = $("#FilterTable");

            var isValid = validateFilters();
            if (!isValid) {
                return;
            };

            var selectedColumn = columnSelect.getSelectedText();
            var filterCondition = filterConditionSelect.getSelectedText();

            var value = valueInputText.val();
            var and = andInputText.val();

            var duplicate = false;

            grid.find("tbody tr").each(function () {
                var el = $(this);
                var columnName = el.find("td:nth-child(2)").text();
                var condition = el.find("td:nth-child(3)").text();

                if (columnName === selectedColumn &&
                    condition === filterCondition) {

                    el.find("td:nth-child(4)").text(value);
                    el.find("td:nth-child(5)").text(and);

                    el.addClass("warning");
                    duplicate = true;
                    return false;
                };
            });


            if (!duplicate) {
                addFilterRow(selectedColumn, filterCondition, value, and);
            };
        });


        function addFilterRow(selectedColumn, filterCondition, value, and, css) {
            var html = "<tr>";
            html += "<td>" + commandItems + "</td>";
            html += "<td>" + selectedColumn + "</td>";
            html += "<td>" + filterCondition + "</td>";
            html += "<td>" + value + "</td>";
            html += "<td>" + and + "</td>";
            html += "</tr>";

            var row = $(html);

            if (css) {
                row.addClass(css);
            };

            $("#FilterTable").removeClass("inverted red").find("tbody").append(row);
            columnSelect.parent().find(".search").focus();
        };

        $("#ManageFiltersButton").click(function () {
            $('.filter.modal').modal('show');
        });

        $("#SaveFilterButton").click(function () {
            var table = $("#FilterTable");
            var filterNameInputText = $("#FilterNameInputText");

            if (isNullOrWhiteSpace(filterNameInputText.val())) {
                makeDirty(filterNameInputText);
                return;
            };

            removeDirty(filterNameInputText);

            if (!table.find("tbody tr").length) {
                table.addClass("inverted red");
                return;
            };

            table.removeClass("inverted red");

            var error = table.find("tr.error td:nth-child(2)").text();

            if (error.length) {
                var message = window.Resources.Questions.ColumnInvalidAreYouSure();

                var confirmed = confirm(stringFormat(message, error));
                if (!confirmed) {
                    return;
                };
            };

            var filters = [];

            $("#FilterTable tbody tr").each(function () {
                var el = $(this);
                var columnName = el.find("td:nth-child(2)").text();
                var condition = el.find("td:nth-child(3)").text();

                var filter = new Object();

                filter.FilterId = window.filterId;
                filter.FilterStatement = "AND";
                filter.ObjectName = scrudFactory.viewTableName;
                filter.FilterName = filterNameInputText.val();

                filter.ColumnName = Enumerable.From(columns)
                    .Where(function (x) { return x.text === columnName }).ToArray()[0].name;

                filter.FilterCondition = parseInt(
                    Enumerable.From(filterConditions)
                    .Where(function (x) { return x.text === condition })
                    .ToArray()[0].value
                    || 0);

                filter.FilterValue = el.find("td:nth-child(4)").text();
                filter.FilterAndValue = el.find("td:nth-child(5)").text();
                filters.push(filter);
            });

            var saveFilterAjax = saveFilter(filterNameInputText.val(), filters);

            saveFilterAjax.success(function () {
                window.filterId = 0;
                displayMessage(Resources.Titles.TaskCompletedSuccessfully(), "success");
            });

            saveFilterAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });
        });

        function saveFilter(filterName, filters) {
            var url = "/api/core/filter/recreate/" + scrudFactory.viewTableName + "/" + filterName;
            var data = JSON.stringify(filters);

            return getAjaxRequest(url, "PUT", data);
        };


        function createFilters(filters) {
            $("#FilterTable").find("tbody").html("");

            $.each(filters, function (i, filter) {
                var selectedColumn = filter.ColumnName;
                var filterCondition = filter.FilterCondition;
                var value = filter.FilterValue;
                var and = (filter.FilterAndValue || "");

                var css = "";

                filterCondition = Enumerable.From(filterConditions)
                    .Where(function (x) { return x.value === filterCondition.toString() })
                    .Select(function (x) { return x.text }).ToArray()[0];

                column = Enumerable.From(columns)
                    .Where(function (x) { return x.name === selectedColumn }).ToArray()[0];

                if (column) {
                    selectedColumn = column.text;
                } else {
                    css = "error";
                };

                addFilterRow(selectedColumn, filterCondition, value, and, css);
            });
        };

        function deleteFilter(el) {
            if (confirmAction()) {
                $(el).parent().parent().remove();
            };

        };

    </script>

    <script>
        $("#MakeUserDefaultFilterButton").click(function () {
            var filterName = $("#FilterSelect").getSelectedText();
            var makeDefaultFilterAjax = makeDefaultFilter(filterName);

            makeDefaultFilterAjax.success(function () {
                displayMessage(Resources.Labels.TaskCompletedSuccessfully(), "success");

                $(".filter.modal").modal("close");
            });

            makeDefaultFilterAjax.fail(function (xhr) {
                logAjaxErrorMessage(xhr);
            });
        });

        function makeDefaultFilter(filterName) {
            var url = "/api/core/filter/make-default/" + scrudFactory.viewTableName + "/" + filterName;
            return getAjaxRequest(url, "PUT");
        };

    </script>

    <script>
        function changeTab(el) {
            el = $(el);
            var tab = el.attr("data-target");

            $.tab('change tab', tab);

            el.parent().find(".active.item").removeClass("active");
            el.addClass("active");
        };

        function setPageNumber(pageNumber) {
            var url = updateQueryString("Page", pageNumber);
            window.history.pushState({ path: url }, '', url);
        };

        function showNextPage() {
            var totalPage = parseInt($(".total.pages.anchor:first").text() || 1);
            var nextPage = getPageNumber() + 1;

            if (nextPage > totalPage) {
                nextPage = totalPage;
            };

            setPageNumber(nextPage);

            loadPageCount(loadGrid);
        };


        function showPreviousPage() {
            var previousPage = getPageNumber() - 1;

            if (previousPage < 1) {
                previousPage = 1;
            };

            setPageNumber(previousPage);

            loadPageCount(loadGrid);
        };
    </script>
    <script>
        $("#DownloadTemplateButton").click(function () {
            var downloadTemplateAjax = downloadTemplate();
            var el = this;

            if (!el.href) {
                $(el).addClass("loading");

                downloadTemplateAjax.success(function (json) {
                    var csv = jsonToCsv(json);
                    var uri = 'data:text/csv;charset=utf-8,' + escape(csv);
                    el.href = uri;
                    el.target = "_blank";
                    el.download = scrudFactory.title + ".csv";

                    $(el).removeClass("loading");

                    el.click();
                });

                downloadTemplateAjax.fail(function () {
                    $(el).removeClass("loading");
                });
            };
        });

        function jsonToCsv(json) {

            var header = "";
            var rows = "";

            $.each(json[0], function (name) {
                if (header) {
                    header += ",";
                };

                header += '"' + name.replace(/"/g, '""') + '"';
            });

            header += "\r\n";

            $.each(json, function (i, value) {
                var row = "";

                $.each(value, function (key, val) {
                    if (row) {
                        row += ",";
                    };

                    if (val == null) {
                        row += '""';
                    }
                    else {
                        row += '"' + val.toString().replace(/"/g, '""') + '"';
                    };
                });

                row += "\r\n";
                rows += row;
            });

            var csv = header + rows;
            return csv;
        };


        function toProperCase(str) {
            var result = str.replace(/_([a-z])/g, function (g) { return g[1].toUpperCase(); });
            return result.charAt(0).toUpperCase() + result.slice(1);
        };


        function downloadTemplate() {
            var url = scrudFactory.formAPI + "/export";
            return getAjaxRequest(url);
        };

        function bulkImport(entities) {
            var url = scrudFactory.formAPI + "/bulk-import";
            var data = JSON.stringify(entities);
            return getAjaxRequest(url, "PUT", data);
        };
    </script>
    <script>
        $("#file").change(function () {
            var el = $(this);
            $(".big.error").removeClass("vpad8").html("");
            var file = this.files[0];

            if (!file) {
                return;
            };

            var supportedFileTypes = ["text/csv", "application/csv"];

            if (supportedFileTypes.indexOf(file.type) === -1) {
                $(".big.error").addClass("vpad8").html(stringFormat(window.Resources.Labels.UploadInvalidTryAgain(), file.type));
                return;
            };

            $("#ProgressBar").show();
            var progress = $(".progress");

            showProgress(progress, 25, window.Resources.Labels.ProcessingYourCSVFile());

            var reader = new FileReader();

            reader.onload = function () {
                var result = reader.result;
                showProgress(progress, 50, window.Resources.Labels.SuccessfullyProcessedYourFile());
                var entities = Papa.parse(result, { "header": true, skipEmptyLines: true }).data;

                showProgress(progress, 50, window.Resources.Labels.RequestingImport());

                el.closest(".segment").find(".button").addClass("loading");

                var bulkImportAjax = bulkImport(entities);

                bulkImportAjax.success(function () {
                    var message = stringFormat(window.Resources.Labels.ImportedNItems(), entities.length);
                    showProgress(progress, 100, message);
                    el.closest(".segment").find(".button").removeClass("loading");
                });

                bulkImportAjax.fail(function (xhr) {
                    $(".big.error").addClass("vpad8").html(getAjaxErrorMessage(xhr));
                    el.closest(".segment").find(".button").removeClass("loading");
                    showProgress(progress, 0, window.Resources.Labels.RollingBackChanges());
                    $("#ProgressBar").fadeOut(2000);
                });
            };

            reader.readAsText(file);
        });

        function showProgress(el, percentage, message) {
            el.attr("data-percent", percentage.toString());
            el.find(".bar").css("width", percentage.toString() + "%");
            el.find(".label").text(percentage.toString() + "% - " + message);
        };
    </script>
    <script>
        function deleteRow(el, isCard) {
            var confirmed = confirmAction();

            if (!confirmed) {
                return;
            };

            var primaryKeyValue = getPrimaryKeyValue($(el), isCard);

            var deleteAjax = deleteEntity(primaryKeyValue);

            deleteAjax.success(function () {
                var confirmed = confirm(window.Resources.Labels.TaskCompletedSuccessfullyRefreshView());

                if (confirmed) {
                    loadPageCount(loadGrid);
                };
            });
        };

        function getKeyColumnPosition() {
            if (typeof (scrudFactory.keyColumnPosition) === "undefined") {
                scrudFactory.keyColumnPosition = "3";
            };

            return scrudFactory.keyColumnPosition;
        };

        function isCardView() {
            var kanban = $('div[data-target="kanban"]');
            return kanban.is(":visible");
        };

        function getPrimaryKeyValue(sender, isCard) {
            if (!isCard) {
                if (isCardView()) {
                    var kanban = $('div[data-target="kanban"]');
                    var selected = kanban.find("input:checked:first-child");
                    isCard = true;
                    sender = selected;
                };
            };


            if (isCard) {
                var card = sender.closest(".card");
                return card.attr("data-key");
            };

            var selector = "td:nth-child(" + getKeyColumnPosition() + ")";
            var primaryKeyValue = sender.parent().parent().find(selector).text();
            return primaryKeyValue;
        };

        function editRow(el, isCard) {
            var confirmed = confirmAction();

            if (!confirmed) {
                return;
            };

            if (window.scrudForm === "undefined") {
                displayMessage(window.Resources.Labels.NoFormFound());
                return;
            };

            var primaryKeyValue = getPrimaryKeyValue($(el), isCard);

            var tableName = scrudFactory.formTableName;

            if (checkIfProcedure()) {
                return;
            };

            var getViewForEditAjax = getViewForEdit(primaryKeyValue);

            getViewForEditAjax.success(function (data) {
                displayEdit(data, false);

                getCustomFieldsForEdit(tableName, primaryKeyValue).success(function (msg) {
                    displayCustomFields(msg);
                    window.scrudView.hide();
                    window.scrudForm.fadeIn(500);
                });
            });
        };



        function displayEdit(items) {
            for (var id in items) {
                var value = items[id];
                if (value != null) {
                    editFormElement(toUnderscoreCase(id), value);
                };
            };
        };

        function displayCustomFields(items) {
            $.each(items, function (i, v) {
                var id = v.FieldName;
                var value = v.Value;

                editFormElement(id, value);
            });
        };

        function editFormElement(id, value) {
            var targetEl = $("#" + id);

            if (targetEl.length) {
                if (targetEl.hasClass("date")) {
                    value = value.toString().toFormattedDate();
                };

                if (targetEl.attr("data-type") === "time") {
                    value = getTime(value);
                };

                targetEl.val(value);

                if (targetEl.attr("data-type") === "image") {
                    initializeUploader();
                };

                if (targetEl.is("select")) {
                    var type = targetEl.attr("data-type");

                    if (type === "bool") {
                        value = value ? "yes" : "no";
                    };

                    targetEl.dropdown("set selected", value.toString());
                    targetEl.trigger("blur");
                    targetEl.trigger("change");
                    return;
                };

                targetEl.trigger("blur");
                targetEl.trigger("change");
                targetEl.trigger("keyup");
            };
        };
    </script>
    <script>

        function deleteEntity(primaryKeyValue) {
            var url = scrudFactory.formAPI + "/delete/" + primaryKeyValue;
            return getAjaxRequest(url, "DELETE");
        };

        function getViewForEdit(primaryKeyValue) {
            var url = scrudFactory.formAPI + "/" + primaryKeyValue;
            return getAjaxRequest(url);
        };

        function getCustomFieldsForEdit(tableName, primaryKeyValue) {
            var url = "/api/core/custom-field-view/get-where/1";

            var filters = [];

            filters.push(window.getAjaxColumnFilter("WHERE", "table_name", FilterConditions.IsEqualTo, tableName));
            filters.push(window.getAjaxColumnFilter("AND", "resource_id", FilterConditions.IsEqualTo, primaryKeyValue));

            var data = JSON.stringify(filters);

            return getAjaxRequest(url, "POST", data, false);
        };
    </script>

    <script>
        function createPDFDocument(html, documentName) {
            var url = "/Services/CreateDocument.asmx/CreatePdf";
            var data = appendParameter("", "html", html);
            data = appendParameter(data, "documentName", documentName);
            data = getData(data);

            return getAjax(url, data);
        };

        function createXlsDocument(html, documentName) {
            var url = "/Services/CreateDocument.asmx/CreateXls";
            var data = appendParameter("", "html", html);
            data = appendParameter(data, "documentName", documentName);
            data = getData(data);

            return getAjax(url, data);
        };

        function createDocDocument(html, documentName) {
            var url = "/Services/CreateDocument.asmx/CreateDoc";
            var data = appendParameter("", "html", html);
            data = appendParameter(data, "documentName", documentName);
            data = getData(data);

            return getAjax(url, data);
        };

        function getFileName() {
            var filterName = ($("#DefaultFilterSelect").val() || "");

            if (filterName) {
                filterName += "-";
            };

            return scrudFactory.title + "-" + filterName + stringFormat(Resources.Titles.PageN(), getPageNumber());
        };

        function createPDF() {
            printGridView(reportExportTemplatePath, reportHeaderPath, scrudFactory.title, "ScrudView", date, user, office, '', 2, 0, $("#MarkupHidden"), null, downloadPDF);
        };

        function createXls() {
            printGridView(reportExportTemplatePath, reportHeaderPath, scrudFactory.title, "ScrudView", date, user, office, '', 2, 0, $("#MarkupHidden"), null, downloadXls);
        };

        function createDoc() {
            printGridView(reportExportTemplatePath, reportHeaderPath, scrudFactory.title, "ScrudView", date, user, office, '', 2, 0, $("#MarkupHidden"), null, downloadDoc);
        };

        function print() {
            printGridView(reportExportTemplatePath, reportHeaderPath, scrudFactory.title, "ScrudView", date, user, office, '', 2, 0);
        };

        function downloadXls() {
            var html = $("#MarkupHidden").val();
            var fileName = getFileName() + ".xls";
            var createXlsDocumentAjax = createXlsDocument(html, fileName);

            createXlsDocumentAjax.success(function (msg) {
                startDownload(msg.d);
            });
        };

        function downloadDoc() {
            var html = $("#MarkupHidden").val();
            var fileName = getFileName() + ".doc";
            var createDocDocumentAjax = createDocDocument(html, fileName);

            createDocDocumentAjax.success(function (msg) {
                startDownload(msg.d);
            });
        };


        function downloadPDF() {
            var html = $("#MarkupHidden").val();
            var fileName = getFileName() + ".pdf";
            var createPDFDocumentAjax = createPDFDocument(html, fileName);

            createPDFDocumentAjax.success(function (msg) {
                startDownload(msg.d);
            });
        };

        function startDownload(path) {
            var anchor = $("#DownloadAnchor");
            anchor.attr("href", path);
            anchor[0].click();
        };

    </script>
</div>

<input type="hidden" id="MarkupHidden" />
<a id="DownloadAnchor" download />



<script>
    var filterPopUnder = $("#FilterPopUnder");
    var flagPopUnder = $("#FlagPopUnder");
    var flagButton = $("#FlagButton");
    var filterButton = $("#FilterButton");
    var flagSelect = $("#FlagSelect");
    var updateButton = $("#UpdateButton");
    var verificationPopUnder = $("#VerificationPopUnder");
    var reasonTextArea = $("#ReasonTextArea");

    $(document).on("viewready", function () {
        initializeFlag();

        flagButton.click(function () {
            popUnder(flagPopUnder, flagButton);
        });

        filterButton.click(function () {
            popUnder(filterPopUnder, filterButton);
        });
    });

    function popUnder(div, button) {
        $(".popunder").hide();
        div.removeClass("initially hidden");
        div.fadeIn(500).position({
            my: "left top",
            at: "left bottom",
            of: button
        });
    };



    function displayFlaggedCards() {
        if (!window.flagDefinition) {
            return;
        };

        if (!window.kanbans) {
            return;
        };


        $.each(window.flagDefinition, function (i, v) {
            var card = $('.card[data-key="' + v.ResourceId + '"]');
            card.attr("data-flag-id", v.FlagId);
            card.attr("data-flag", v.FlagTypeName);

            if (card.length) {
                var flag = $('<a class="ui red top right attached label" />');
                flag.text(v.FlagTypeName);

                card.find(".content .header").append(flag);

                card.css("background-color", v.BackgroundColor);
                card.css("color", v.ForegroundColor);
            };
        });
    };

    function displayFlaggedRows() {
        $("#ScrudView").find("tbody tr").each(function () {
            var row = $(this);
            var resourceId = row.find("td:nth-child(3)").text();

            var data = Enumerable.From(window.flagDefinition)
                .Where(function (x) { return x.ResourceId === resourceId }).ToArray()[0];

            if (data) {
                row.css("background-color", data.BackgroundColor);
                row.css("color", data.ForegroundColor);
                row.attr("data-flag", data.FlagTypeName);
                row.attr("data-flag-id", data.FlagId);
            };
        });
    };

    function initializeFlag() {
        function getFlagTypes() {
            var url = "/api/core/flag-type/display-fields";
            return getAjaxRequest(url);
        };

        function addFlag(flag) {
            var url = "/api/core/flag/add-or-edit";
            var data = JSON.stringify(flag);
            return getAjaxRequest(url, "PUT", data);
        };

        function deleteFlag(flagId) {
            var url = "/api/core/flag/delete/" + flagId;
            return getAjaxRequest(url, "DELETE");
        };

        if (!flagSelect.find("option").length) {
            var getFlagTypesAjax = getFlagTypes();

            getFlagTypesAjax.success(function (msg) {
                bindSelect(flagSelect, msg, "Key", "Value");
                var options = "<option value='0'>" + Resources.Titles.None() + "</option>";
                options += flagSelect.html();
                flagSelect.html(options);
                flagSelect.dropdown();
            });
        };

        function getSelectionCardView() {
            var collection = [];

            var kanban = $('div[data-target="kanban"]');
            var selected = kanban.find("input:checked");

            if (selected.length === 0) {
                return collection;
            };

            selected.each(function () {
                var el = $(this);
                var card = el.closest(".card");

                var selection = new Object();
                selection.FlagId = (card.attr("data-flag-id") || 0);
                selection.ResourceId = (card.attr("data-key") || 0);

                collection.push(selection);
            });

            return collection;
        };

        function getSelection() {
            var collection = [];

            if (isCardView()) {
                return getSelectionCardView();
            };


            var selectedElements = $("input:checkbox:checked").closest("tr");
            if (selectedElements.length === 0) {
                return collection;
            };

            selectedElements.each(function () {
                var el = $(this);
                var selection = new Object();
                selection.FlagId = (el.attr("data-flag-id") || 0);
                selection.ResourceId = el.find("td:nth-child(3)").text();

                collection.push(selection);
            });


            return collection;
        };


        updateButton.unbind("click").click(function () {
            var selection = getSelection();

            if (selection.length === 0) {
                return;
            };

            $.each(selection, function (i, v) {
                var flag = new Object();


                flag.FlagId = v.FlagId;
                flag.ResourceId = v.ResourceId;
                flag.FlagTypeId = parseInt(flagSelect.val());
                flag.Resource = scrudFactory.viewTableName;
                flag.ResourceKey = "";

                var flagAjax;

                if (flag.FlagTypeId) {
                    flagAjax = addFlag(flag);
                } else {
                    flagAjax = deleteFlag(flag.FlagId);
                };


                flagAjax.success(function () {
                    if (i + 1 === selection.length) {
                        if (flag.FlagTypeId) {
                            window.displayMessage(window.Resources.Labels.FlagSaved(), "success");
                        } else {
                            window.displayMessage(window.Resources.Labels.FlagRemoved());
                        };

                        loadPageCount(loadGrid);
                    };
                });

                flagAjax.fail(function (xhr) {
                    logAjaxErrorMessage(xhr);
                });
            });
        });


        function getIds() {
            var ids = [];
            $("#ScrudView").find("td:nth-child(3)").each(function () {
                ids.push($(this).text());
            });

            return ids;
        };

        function getFlagView(resource, userId, flagIds) {
            var url = "/api/core/flag-view/get/";
            url += resource + "/";
            url += userId;
            url += "?resourceIds=";
            url += flagIds.join("&resourceIds=");

            return getAjaxRequest(url);
        };

        function displayFlags() {
            var ids = getIds();

            var getFlagViewAjax = getFlagView(scrudFactory.viewTableName, userId, ids);

            getFlagViewAjax.success(function (msg) {
                window.flagDefinition = msg;

                displayFlaggedRows();
                displayFlaggedCards();
            });
        };

        displayFlags();
    };


</script>

<script>
    $(".action.buttons .button").click(function () {
        $(".action.buttons .button").removeClass("active");
        var el = $(this);
        var target = el.attr("data-target");

        if (target) {
            showTarget(target);
        };

        var url = updateQueryString("View", target);
        window.history.pushState({ path: url }, '', url);
    });


    $(document).ready(function () {
        var view = getQueryStringByName("View");
        if (view) {
            showTarget(view);
        };
    });
</script>

<script>
    $(function () {
        $(".kanban.segments").css("width", (($(".segment").length - 1) * 300) + "px").fadeIn(500);
    });

    var kanbanTemplate = '<div id="kanban{KanbanId}" class="ui segment">\
                    <span class="ui teal left large label" data-kanban-id="{KanbanId}" title="{Description}">{KanbanName}</span>\
                    <div class="ui right floated tiny basic icon buttons">\
                        <a title="{AddNewCheckListLocalized}" class="ui basic button" href="javascript:void(0);" onclick="addKanban();"><i class="add icon"></i></a>\
                        <a title="{EditThisCheckListLocalized}" class="ui basic button" href="javascript:void(0);" onclick="editKanban(this);"><i class="edit icon"></i></a>\
                        <a title="{DeleteThisCheckListLocalized}" class="ui basic button" href="javascript:void(0);" onclick="deleteKanban(this);"><i class="delete icon"></i></a>\
                    </div>\
                    <div class="ui clearing padded divider"></div> \
                    <div class="kanban holder"></div> \
                </div>';

    function createKanbanSegment(kanban) {
        var local = kanbanTemplate;
        local = local.replace(/{KanbanId}/g, kanban.KanbanId);
        local = local.replace(/{KanbanName}/g, kanban.KanbanName);
        local = local.replace(/{Description}/g, kanban.Description);
        local = local.replace("{AddNewCheckListLocalized}", window.Resources.Titles.AddNewChecklist());
        local = local.replace("{EditThisCheckListLocalized}", window.Resources.Titles.EditThisChecklist());
        local = local.replace("{DeleteThisCheckListLocalized}", window.Resources.Titles.DeleteThisChecklist());

        var el = $(local);

        $("#kanban").append(el);
    };

    function createKanbans(kanbans) {
        $("#kanban").html("");

        var kanban = new Object();
        kanban.KanbanId = "0";
        kanban.KanbanName = Resources.Titles.Untitled();
        createKanbanSegment(kanban);

        $.each(kanbans, function (i, kanban) {
            createKanbanSegment(kanban);
        });

        createCards();
    };

    function getKanbans() {
        var url = "/api/core/kanban/get-where/1";

        var filters = [];
        filters.push(getAjaxColumnFilter("WHERE", "object_name", FilterConditions.IsEqualTo, scrudFactory.viewTableName));
        filters.push(getAjaxColumnFilter("WHERE", "user_id", FilterConditions.IsEqualTo, window.userId));

        var data = JSON.stringify(filters);

        return getAjaxRequest(url, "POST", data, false);
    };

    $(document).ready(function () {
        refreshKanbans();
    });

    function refreshKanbans() {
        var getKanbansAjax = getKanbans();

        getKanbansAjax.success(function (msg) {
            window.kanbans = msg;
            createKanbans(msg);
        });
    };

    function addKanban() {
        $("#KanbanForm").modal("show");
    };

    function deleteKanban(el) {
        function ajax(kanbanId) {
            var url = "/api/core/kanban/delete/" + kanbanId;
            return getAjaxRequest(url, "DELETE");
        };

        el = $(el);
        var label = el.parent().parent().find(".label");
        var kanbanId = parseInt(label.attr("data-kanban-id"));

        if (kanbanId) {
            var confirmed = confirmAction();

            if (!confirmed) {
                return;
            };

            var ajaxRequst = ajax(kanbanId);

            ajaxRequst.success(function () {
                refreshKanbans();
            });
        };
    };

    function editKanban(el) {
        el = $(el);
        var label = el.parent().parent().find(".left.label");

        var kanbanId = parseInt(label.attr("data-kanban-id"));
        var kanbanName = label.text();
        var description = label.attr("title");


        if (kanbanId) {
            $("#KanbanIdInputText").val(kanbanId);
            $("#KanbanNameInputText").val(kanbanName);
            $("#KanbanDescriptionTextArea").val(description);

            $("#KanbanForm").modal("show");
        };
    };

    function saveOrUpdateKanban() {
        function addOrEditKanban(k) {
            var url = "/api/core/kanban/add-or-edit";

            var form = [];
            form.push(k);
            form.push(null);

            var data = JSON.stringify(form);
            return getAjaxRequest(url, "PUT", data);
        };

        var kanbanIdInputText = $("#KanbanIdInputText");
        var kanbanNameInputText = $("#KanbanNameInputText");
        var kanbanDescriptionTextArea = $("#KanbanDescriptionTextArea");

        if (isNullOrWhiteSpace(kanbanNameInputText.val())) {
            makeDirty(kanbanNameInputText);
            return;
        };

        removeDirty(kanbanNameInputText);

        var kanban = new Object();
        kanban.KanbanId = (kanbanIdInputText.val() || 0);
        kanban.ObjectName = scrudFactory.viewTableName;
        kanban.UserId = window.userId;
        kanban.KanbanName = kanbanNameInputText.val();
        kanban.Description = kanbanDescriptionTextArea.val();

        var addOrEditKanbanAjax = addOrEditKanban(kanban);

        addOrEditKanbanAjax.success(function () {
            $("#KanbanForm").modal("hide");
            refreshKanbans();
        });
    };
</script>


<script src="/Scripts/mixerp/utitlities/localizable.js"></script>