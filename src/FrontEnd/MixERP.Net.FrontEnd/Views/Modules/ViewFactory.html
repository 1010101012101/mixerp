<div class="poco view factory">
    <div class="ui stackable attached segment">
        <div class="title ui huge grey header"></div>
        <div class="ui info description message"></div>
    </div>
    <div class="ui stackable attached segment">
        <script src="/Scripts/underscore/underscore-min.js"></script>

        <div class="ui stackable grid">
            <div class="twelve wide column">

                <a onclick="addNew();" class="ui basic green left attached button">Add New</a>
                <div class="ui icon top left pointing dropdown basic teal right attached button">
                    <span>Export This Document</span>
                    <div class="menu">
                        <div class="header">
                            Export This Document
                        </div>
                        <div class="item">
                            <i class="file word outline blue icon"></i>
                            To Word Document
                        </div>
                        <div class="item">
                            <i class="file excel outline green icon"></i>
                            To Word Document
                        </div>
                        <div class="item">
                            <i class="file pdf outline red icon"></i>
                            To PDF Document
                        </div>
                    </div>
                </div>

            </div>
            <div class="right aligned four wide column">
                <select class="ui fluid filter" id="DefaultFilterSelect"></select>
            </div>
        </div>
    </div>

<div class="ui stackable attached segment">
    <div class="ui top attached tabular menu">
        <a class="active item" data-tab="view" onclick="changeTab(this)">View</a>
        <a class="item" data-tab="filter" onclick="changeTab(this)">Manage Filters</a>
    </div>

    <div class="ui active bottom attached tab loading segment" data-tab="view">
        <div id="json" class="vpad8" style="width: 100%; overflow: auto;">
        </div>
        <div class="ui stackable grid">
            <div class="left aligned six wide column">
                <div class="ui breadcrumb">
                    <a class="section" id="CurrentPageAnchor"></a>
                    <div class="divider">/ </div>
                    <a class="section" id="TotalPagesAnchor"></a>
                </div>
            </div>
            <div class="right aligned ten wide column">
                <a class="ui left attached labeled icon button"><i class="left arrow icon"></i>Previous</a>
                <a class="ui right attached right labeled icon button">Next<i class="right arrow icon"></i></a>
            </div>
        </div>
    </div>

    <div class="ui bottom attached hidden tab segment" data-tab="filter">
        <div class="ui basic buttons">
            <div class="ui basic button">Create a Filter</div>
            <div class="ui basic button" onclick="$('.filter.modal').modal('show');">Manage Filters</div>
        </div>

        <div class="ui huge header">
            Filter:
            <span id="FilterName"></span>
        </div>
        <div class="ui divider"></div>

        <div class="ui stackable form" id="FilterForm">
            <div class="five fields">
                <div class="field">
                    <label>Select Column</label>
                    <select class="ui search dropdown" id="ColumnSelect" required></select>
                </div>
                <div class="field">
                    <label>Filter Condition</label>
                    <select class="ui search dropdown" id="FilterConditionSelect" required></select>
                </div>
                <div class="field">
                    <label>Value</label>
                    <input id="ValueInputText" required/>
                </div>
                <div class="field">
                    <label>And</label>
                    <input id="AndInputText" readonly="readonly"/>
                </div>
                <div class="field">
                    <label>&nbsp;</label>
                    <input class="ui button" onclick="addFilter();" type="button" value="Add">
                </div>
            </div>
        </div>

        <table class="ui striped table" id="FilterTable">
            <thead>
            <tr>
                <th style="width: 100px;">Actions</th>
                <th>Column Name</th>
                <th>Condition</th>
                <th>Value</th>
                <th>And</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="filters" class="vpad8">
        </div>

        <div class="ui basic buttons">
            <div class="ui basic button">Search</div>
            <div class="ui basic button">Close</div>
        </div>

        <div class="ui large header">Save this Filter</div>
        <div class="ui divider"></div>
        <div class="ui form">
            <div class="fields">
                <div class="four wide field">
                    <label>Filter Name</label>
                    <input id="FilterNameInputText"/>
                </div>
            </div>
            <div class="ui buttons">

                <div class="ui basic green button" id="SaveFilterButton">Save</div>
                <div class="ui button" id="SaveAndDefaultFilterButton">Save & Make Default</div>
                <div class="ui basic red button">Cancel</div>
            </div>
        </div>

        <div class="ui filter small modal">
            <i class="close icon"></i>
            <div class="ui huge header">
                Manage Filters
            </div>
            <div class="content">
                <div class="ui form" style="max-width: 400px;">
                    <div class="field">
                        <label>Select a Filter</label>
                        <select class="ui search dropdown filter" id="FilterSelect"></select>
                    </div>
                    <div class="ui basic buttons">
                        <a class="ui close button" onclick="loadFilter();">Edit</a>
                        <a class="ui close button" onclick="loadFilter();">Delete</a>
                        <a class="ui close button">Close</a>
                    </div>

                </div>
            </div>
            <div class="actions">
                <div class="ui basic buttons">
                    <a class="ui basic red close button" onclick="removeUserDefaults();">Remove User Defaults</a>
                    <a class="ui basic purple close button" onclick="removeAdminDefaults();">Remove Admin Defaults</a>
                    <a class="ui basic teal button" onclick="defaultUserFilter();">Default (For Users)</a>
                    <a class="ui basic blue close button" onclick="defaultAdminFeature();">Default (For Admins)</a>
                </div>
            </div>
        </div>

    </div>

</div>

        <br />
        <script>
            var form = $(".poco.form.factory");
            var view = $(".poco.view.factory");

            if (form.length) {
                form.hide();
            };

            function addNew() {
                if (form.length) {
                    view.hide();
                    form.show();
                };
            };

        </script>

        <script>
            var columns = [];
            var filterConditions = [{ "value": "0", "text": "IsEqualTo" },
            { "value": "1", "text": "IsNotEqualTo" },
            { "value": "2", "text": "IsLessThan" },
            { "value": "3", "text": "IsLessThanEqualTo" },
            { "value": "4", "text": "IsGreaterThan" },
            { "value": "5", "text": "IsGreaterThanEqualTo" },
            { "value": "6", "text": "IsBetween" },
            { "value": "7", "text": "IsNotBetween" },
            { "value": "8", "text": "IsLike" },
            { "value": "9", "text": "IsNotLike" }];

            var untitledLocalized = "Untitled";
        </script>
        <script>
            function tryParseLocalizedResource(text) {
                var localized = executeFunctionByName("Resources.Titles." + text, window);

                if (!localized) {
                    localized = executeFunctionByName("Resources.ScrudResource." + text, window);
                };

                if (localized) {
                    return localized;
                };

                return text;
            };

            function localizeHeaders(el) {
                el.find("thead tr th").each(function () {
                    var cell = $(this);

                    var name = cell.text();

                    var text = tryParseLocalizedResource(name);
                    cell.text(text);

                    var column = new Object();
                    column.name = name;
                    column.text = text;

                    columns.push(column);
                });
            };
        </script>
        <script>
            json2Table = function (json, excludedColumnIndices) {
                if (!json) {
                    return null;
                };

                if (!excludedColumnIndices) {
                    excludedColumnIndices = [];
                };

                var el = $('<table class="ui striped nowrap table">');
                var header = "<thead><tr>";

                var index = 0;
                $.each(json[0], function (name) {
                    if (excludedColumnIndices.indexOf(index) === -1) {
                        header += "<th>" + name + "</th>";
                    };

                    index++;
                });


                header += "</tr></thead>";

                $(header).appendTo(el);

                var body = $("<tbody />");

                $.each(json, function (i, value) {
                    var row = "<tr>";

                    index = 0;
                    $.each(value, function (key, val) {
                        if (excludedColumnIndices.indexOf(index) === -1) {
                            row += "<td>" + (val || "") + "</td>";
                        };

                        index++;
                    });

                    row += "</tr>";

                    body.append(row);
                });

                $(el).append(body);

                return $(el);
            };

            function createJsonTable(el, json) {
                el.html("");

                var mydata = eval(json);
                var table = json2Table(mydata, window.excludedColumnIndices);
                $(table).appendTo(el);
            };

        </script>
        <script>
            //Utilities
            function getPageNumber() {
                var page = parseInt(getQueryStringByName("Page") || 0);
                var totalPage = parseInt($("#TotalPagesAnchor").text() || 1);

                if (!page) {
                    return 1;
                };

                if (page > totalPage) {
                    page = totalPage;
                };

                return page;
            };

            function getFilter() {
                if ($("#DefaultFilterSelect").val()) {
                    var filter = $("#DefaultFilterSelect").getSelectedValue();
                    return filter;
                };

                return "";
            };

            function bindSelect(el, data, valueField, textField) {
                $.each(data, function () {
                    var option = "<option value='" + this[valueField] + "'>" + this[textField] + "</option>";
                    el.append(option);
                });
            };
        </script>
        <script>
            function loadPageCount(callback) {
                $("[data-tab=view]").addClass("loading");
                var filterName = getFilter();

                var ajaxGetTotalPages = getTotalPages(pocoName, filterName, false);

                ajaxGetTotalPages.success(function (msg) {
                    var pages = parseInt(msg.d || 1);

                    $("#TotalPagesAnchor").text(pages);

                    if (typeof callback === "function") {
                        callback();
                    };
                });

                ajaxGetTotalPages.fail(function (xhr) {
                    logAjaxErrorMessage(xhr);
                });

            };

            function getTotalPages(pocoName, filterName, byOffice) {
                var url = "/Services/Modules/PocoService.asmx/GetTotalPages";
                var data = appendParameter("", "pocoName", pocoName);
                data = appendParameter(data, "filterName", filterName);
                data = appendParameter(data, "byOffice", byOffice);

                data = getData(data);
                return getAjax(url, data);
            };
        </script>
        <script>
            function loadFilterConditions() {
                bindSelect($("#FilterConditionSelect"), filterConditions, "value", "text");
            };

            function loadColumns() {
                bindSelect($("#ColumnSelect"), columns, "name", "text");
            };

            $("#FilterNameInputText").keyup(function () {
                $("#FilterName").html($(this).val() || untitledLocalized);
            });

            function loadFilter() {
                var filterName = $("#FilterSelect").getSelectedText();
                $("#FilterName").html(filterName);
                $("#FilterNameInputText").val(filterName);

                var ajaxGetFilters = getFilters(pocoName, filterName);

                ajaxGetFilters.success(function (msg) {
                    createFilters(msg.d);
                });

                ajaxGetFilters.fail(function (xhr) {
                    logAjaxErrorMessage(xhr);
                });
            };

            function getFilters(pocoName, filterName) {
                var url = "/Services/Modules/PocoService.asmx/GetFilters";
                var data = appendParameter("", "pocoName", pocoName);
                data = appendParameter(data, "filterName", filterName);
                data = getData(data);
                return getAjax(url, data);
            };
        </script>
        <script>
            function loadFilterNames() {
                var ajaxGetFilterNames = getFilterNames(pocoName);

                ajaxGetFilterNames.success(function (msg) {
                    var data = msg.d;
                    var selected = "";

                    var option = "<option value='0'>Select a Filter</option>";

                    $.each(data, function () {
                        var isDefault = this[1].Value;

                        if (isDefault) {
                            selected = this[0].Value;
                        };

                        option += stringFormat("<option value='{0}'>{0}</option>", this[0].Value);
                    });


                    $("#DefaultFilterSelect").html(option);

                    if (selected) {
                        $("#DefaultFilterSelect").dropdown("set selected", selected);
                    };

                    $("#FilterSelect").html(option);
                    loadPageCount(loadGrid);
                });

                ajaxGetFilterNames.fail(function (xhr) {
                    logAjaxErrorMessage(xhr);
                });
            };

            function getFilterNames(pocoName) {
                var url = "/Services/Modules/PocoService.asmx/GetFilterNames";
                var data = appendParameter("", "pocoName", pocoName);
                data = getData(data);
                return getAjax(url, data);
            };
        </script>
        <script>
            $("#DefaultFilterSelect").change(function () {
                loadPageCount(loadGrid);
            });
        </script>
        <script>

            $(document).ready(function () {
                loadFilterNames();
                loadFilterConditions();
                if (window.title) {
                    $(".title").html(window.title);
                };
                if (window.description) {
                    $(".description").html(window.description);
                };
            });

            function loadGrid() {
                var pageNumber = getPageNumber();
                var filterName = getFilter();

                $("#CurrentPageAnchor").text(pageNumber);

                var ajaxGetPocoView = getPocoView(pocoName, pageNumber, filterName, false);

                ajaxGetPocoView.success(function (msg) {
                    var el = $("#json");
                    var json = JSON.parse(msg.d);
                    createJsonTable(el, json);
                    localizeHeaders(el);
                    loadColumns();
                    $("[data-tab=view]").removeClass("loading");
                });

                ajaxGetPocoView.fail(function (xhr) {
                    logAjaxErrorMessage(xhr);
                });
            };

            function getPocoView(pocoName, pageNumber, filterName, byOffice) {
                var url = "/Services/Modules/PocoService.asmx/GetPocoView";
                var data = appendParameter("", "pocoName", pocoName);
                data = appendParameter(data, "pageNumber", pageNumber);
                data = appendParameter(data, "filterName", filterName);
                data = appendParameter(data, "byOffice", byOffice);

                data = getData(data);
                return getAjax(url, data);
            };

        </script>
        <script>
            var columnSelect = $("#ColumnSelect");
            var filterConditionSelect = $("#FilterConditionSelect");
            var valueInputText = $("#ValueInputText");
            var andInputText = $("#AndInputText");
            var commandItems = "<a onclick='deleteFilter(this);'><i class='delete icon'></i></a><a onclick='editFilter(this);'><i class='edit icon'></i></a><a onclick='$(this).parent().parent().toggleClass(\"warning\");'><i class='check mark icon'></i></a>";



            filterConditionSelect.change(function () {
                var val = parseFloat(filterConditionSelect.val() || 0);

                if (val >= 6 && val <= 7) {
                    andInputText.removeAttr("readonly");
                    return;
                };

                andInputText.attr("readonly", "readonly");
                andInputText.val("");
            });

            function validateFilters() {
                var isValid = true;

                $("#FilterForm [required]").each(function () {
                    var el = $(this);

                    if (isNullOrWhiteSpace(el.val())) {
                        isValid = false;
                        makeDirty(el);
                        return;
                    };

                    removeDirty(el);
                });

                return isValid;
            };

            function addFilter() {
                var grid = $("#FilterTable");

                var isValid = validateFilters();
                if (!isValid) {
                    return;
                };

                var selectedColumn = columnSelect.getSelectedText();
                var filterCondition = filterConditionSelect.getSelectedText();
                var value = valueInputText.val();
                var and = andInputText.val();

                var duplicate = false;

                grid.find("tbody tr").each(function () {
                    var el = $(this);
                    var columnName = el.find("td:nth-child(2)").text();
                    var condition = el.find("td:nth-child(3)").text();

                    if (columnName === selectedColumn &&
                        condition === filterCondition) {

                        el.find("td:nth-child(4)").text(value);
                        el.find("td:nth-child(5)").text(and);

                        el.addClass("warning");
                        duplicate = true;
                        return false;
                    };
                });


                if (!duplicate) {
                    addFilterRow(selectedColumn, filterCondition, value, and);
                };
            };

            function addFilterRow(selectedColumn, filterCondition, value, and, css) {
                var html = "<tr>";
                html += "<td>" + commandItems + "</td>";
                html += "<td>" + selectedColumn + "</td>";
                html += "<td>" + filterCondition + "</td>";
                html += "<td>" + value + "</td>";
                html += "<td>" + and + "</td>";
                html += "</tr>";

                var row = $(html);

                if (css) {
                    row.addClass(css);
                };

                $("#FilterTable").find("tbody").append(row);
                columnSelect.parent().find(".search").focus();
            };

            $("#SaveFilterButton").click(function () {
                var table = $("#FilterTable");
                var error = table.find("tr.error td:nth-child(2)").text();

                if (error.length) {
                    var message = "The column \"{0}\" is invalid and does not exist. Are you sure you want to continue?";

                    var confirmed = confirm(stringFormat(message, error));
                    if (!confirmed) {
                        return;
                    };
                };

                var filters = [];

                $("#FilterTable tbody tr").each(function () {
                    var el = $(this);
                    var columnName = el.find("td:nth-child(2)").text();
                    var condition = el.find("td:nth-child(3)").text();

                    var filter = new Object();

                    filter.FilterName = $("#FilterNameInputText").val();
                    filter.ColumnName = _.findWhere(columns, { text: columnName }).name;
                    filter.FilterCondition = parseInt(_.findWhere(filterConditions, { text: condition }).value || 0);
                    filter.FilterValue = el.find("td:nth-child(4)").text();
                    filter.FilterAndValue = el.find("td:nth-child(5)").text();
                    filters.push(filter);
                });

                var ajaxSaveFilter = saveFilter(pocoName, filters);

                ajaxSaveFilter.success(function (msg) {
                    alert("foo");
                });

                ajaxSaveFilter.fail(function (xhr) {
                    logAjaxErrorMessage(xhr);
                });
            });

            function saveFilter(pocoName, filters) {
                var url = "/Services/Modules/PocoService.asmx/SaveFilter";
                var data = appendParameter("", "pocoName", pocoName);
                data = appendParameter(data, "filters", filters);

                data = getData(data);
                return getAjax(url, data);
            };


            function createFilters(filters) {
                $("#FilterTable").find("tbody").html("");
                $.each(filters, function (i, filter) {
                    var selectedColumn = filter.ColumnName;
                    var filterCondition = filter.FilterCondition;
                    var value = filter.FilterValue;
                    var and = (filter.FilterAndValue || "");

                    var css = "";
                    filterCondition = _.findWhere(filterConditions, { value: filterCondition.toString() }).text;
                    var column = _.findWhere(columns, { name: selectedColumn });

                    if (column) {
                        selectedColumn = column.text;
                    } else {
                        css = "error";
                    };

                    addFilterRow(selectedColumn, filterCondition, value, and, css);
                });
            };

            function deleteFilter(el) {
                if (confirmAction()) {
                    $(el).parent().parent().remove();
                };

            };

        </script>

        <script>
            function defaultUserFilter() {
                var filterName = $("#FilterSelect").getSelectedText();
                var ajaxMakeDefaultFilter = makeDefaultFilter(pocoName, filterName);

                ajaxMakeDefaultFilter.success(function () {
                    displayMessage(Resources.Labels.TaskCompletedSuccessfully(), "success");

                    $(".filter.modal").modal("close");
                });

                ajaxMakeDefaultFilter.fail(function (xhr) {
                    logAjaxErrorMessage(xhr);
                });
            };

            function makeDefaultFilter(pocoName, filterName) {
                var url = "/Services/Modules/PocoService.asmx/MakeDefaultFilter";
                var data = appendParameter("", "pocoName", pocoName);
                data = appendParameter(data, "filterName", filterName);

                data = getData(data);
                return getAjax(url, data);
            };

        </script>
    </div>
