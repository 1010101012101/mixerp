<div class="poco form factory" style="display: none;">
    <script src="/Scripts/underscore/underscore-min.js"></script>
    <div class="ui stackable attached segment">
        <div class="ui grey huge header">
            <span class="title initial value"></span>
            <span class="live"></span>
            <div class="ui sub header">

            </div>
        </div>
        <div class="ui info description message"></div>
    </div>

    <div class="ui stackable attached segment loading form" id="scrud">
    </div>
<div class="ui stackable attached segment">
    <div class="big error"></div>
    <input type="button" id="SaveButton" value="Save" class="ui green button"/>
    <input type="button" id="CancelButton" value="Cancel" class="ui red button"/>
</div>

<script>
    function initializeAjaxRequest() {
        $.each(keys, function() {
            var el = $("[data-property=" + this.property + "]");

            if (el.length) {
                var selectedValue = "";

                if (window.editData) {
                    selectedValue = window.editData[el.attr("id")];
                };

                ajaxDataBind(this.url, el, this.data, selectedValue, null, null, this.valueField, this.textField, this.isArray);
            };
        });
    };

</script>

<script>
    var poco;
    var saveButton = $("#SaveButton");
    var scrud = $("#scrud");
    var cancelButton = $("#CancelButton");
    var form = $(".poco.form.factory");
    var view = $(".poco.view.factory");
    var grid = [undefined, "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen"];
    var editData;
    var dropdownsLoaded = false;
    var defaultValuesLoaded = false;
</script>

<script>
    if (window.title) {
        $(".title").html(window.title);
    };
    if (window.description) {
        $(".description").html(window.description);
    }else{
        $(".description").remove();        
    };

    function getReturnUrl(){
        var returnTo = getQueryStringByName("ReturnUrl");

        var qs = getQueryStrings();

        $.each(qs, function (i, v) {
            if (i !== "ReturnUrl") {
                returnTo = updateQueryString(i, v, returnTo);
            };
        });


        if(!returnTo){
            returnTo = window.returnUrl;
        };

        return (returnTo || "");
    };

    cancelButton.click(function () {
        var confirmed = confirmAction();

        if (!confirmed) {
            return;
        };

        resetForm();

        if (view.length) {
            form.hide();
            view.show();
        };

        if (getReturnUrl()) {
            document.location.href = getReturnUrl();
        };
    });



    saveButton.click(function(){
        var isValid = validate();

        if(!isValid){
            return;
        };

        saveButton.addClass("loading");
        var bigError = $(".big.error");
        var entity = new Object();

        bigError.removeClass("bpad16").html("");

        $.each(poco.Columns, function(i, v){
            var columnName = v.ColumnName;
            var dataType = v.DataType;
            var isSerial = v.IsSerial;

            var el = $("#" + columnName);
            var val = null;

            if(el.length){
                val = el.val();

                if(dataType === "System.Boolean"){
                    val = val === "yes"? true: false;
                }else{
                    val = val.toString().trim();
                };

                if(el.is("select")){
                    if(!val){
                        val = null;
                    };
                };
            };

            if(isSerial){
                if(isNullOrWhiteSpace(val)){
                    val = null;
                };
            };

            entity[columnName] = val;
        });

        var ajaxSaveOrUpdate = saveOrUpdate(formPocoName, entity);


        ajaxSaveOrUpdate.success(function(msg){
            saveButton.removeClass("loading");
            var confirmed = confirm("Task completed successfully. Return to view?");

            resetForm();

            if(confirmed){
                form.hide();

                if(getReturnUrl()){
                    window.location.href = getReturnUrl();
                };

                if(view.length){
                    view.show();
                    loadPageCount(loadGrid);
                };
            };
        });

        ajaxSaveOrUpdate.fail(function(xhr){
            var error = getAjaxErrorMessage(xhr);

            saveButton.removeClass("loading");
            bigError.addClass("bpad16").text(error);
        });

    });

    function resetForm(){
        var fields = $(".form-field");

        $.each(fields, function(){
            var el = $(this);
            var defaultValue = el.attr("data-default-value");

            if(!defaultValue){
                defaultValue = "";
            };

            if(el.hasClass("dropdown")){
                if(!el.hasClass("disabled")){
                    var select = el.find("select");
                    var search = el.find(".search");
                    var text = el.find(".text");

                    select.val("");
                    search.html("");
                    text.html("");                    
                };
            }else{                
                el.val(defaultValue);                
            };
        });
    };

    function validate(){
        var required = $(".poco.form.factory [required]:not(:disabled):not([readonly])");
        required.trigger("blur");

        return form.find(".error").length === 1;
    };

    function getFormView(pocoName) {
        var url = "/Services/Modules/PocoService.asmx/GetFormView";
        var data = appendParameter("", "pocoName", pocoName);

        data = getData(data);
        return getAjax(url, data);
    };

    function saveOrUpdate(pocoName, pocoEntity){
        var url = "/Services/Modules/PocoService.asmx/SaveOrUpdate";
        var data = appendParameter("", "pocoName", pocoName);
        data = appendParameter(data, "pocoEntity", pocoEntity);

        data = getData(data);
        return getAjax(url, data);
    };

</script>

    <script>
        //$(window).load
        $(document).ready(function () {
            var form = $(".poco.form.factory");
            var view = $(".poco.view.factory");

            var defaultView = window.getQueryStringByName("View");

            if ((defaultView || "") === "FormView") {
                if (view.length) {
                    view.hide();
                    form.show();
                };
            } else {
                if (view.length) {
                    form.hide();
                };
            };

            loadEdit();            
        });

        $(document).ajaxStop(function () {
            $("#scrud").removeClass("loading");
            loadDefaultValues();
            loadDropdowns();
            triggerReadyEvent();
        });

        function triggerReadyEvent() {
            $(document).trigger("formready");
        };

        function loadDefaultValues(){
            if(defaultValuesLoaded){
                return;
            };

            var qs = getQueryStrings();

            $.each(qs, function(i, v){
                var name = i;
                var value = v;

                var el = $("[data-property=" + name + "]");

                if(el.length){
                    if(el.is("select")){
                        el.addClass("disabled");
                        el.attr("data-value", value);
                        el.attr("data-default-value", value);                        
                    }else{
                        el.val(value);                        
                    };
                };
            });

            $("input.live").trigger("keyup");
            defaultValuesLoaded = true;
        };

        function loadDropdowns() {
            if (!dropdownsLoaded) {
                var dropdowns = $(".poco.form.factory .dropdown");

                dropdowns.each(function(i, v){
                    var dropdown = $(v);

                    var selectedValue = (dropdown.getSelectedValue() || "");

                    if(!selectedValue){
                        selectedValue = dropdown.attr("data-value");

                        if(selectedValue){
                            dropdown.val(selectedValue);
                        };
                    };

                    dropdown.dropdown();
                });

                dropdownsLoaded = true;
            };
        };

        function createForm(pocoName) {
            var ajaxGetFormView = getFormView(pocoName);

            ajaxGetFormView.success(function (msg) {
                poco = msg.d;

                createLayout(poco.Columns);
            });

        };


        function chunk_array(arr, len) {
            return arr.map(function (e, i) {
                    return i % len === 0 ? arr.slice(i, i + len) : null;
                })
                .filter(function (e) { return e; });
        };

        function createLayout(collection) {
            var skip = [];

            if (typeof (layout) !== "undefined") {
                $.each(layout, function (i, currentLayout) {
                    var actualColumns = _.uniq(currentLayout);
                    var fieldWith = 16 / currentLayout.length;

                    var fields = $("<div class='fields' />");

                    $.each(actualColumns, function (index, propertyName) {
                        var value = _.findIndex(collection, { "PropertyName": propertyName });

                        if (value >= 0) {
                            skip.push(value);

                            var weight = currentLayout.reduce(function (x, y) {
                                return x + (y === propertyName);
                            }, 0);

                            var cssClass = grid[fieldWith * weight] + " wide field";

                            createColumn(fields, collection[value], cssClass);
                        };

                    });

                    scrud.append(fields);
                });
            };


            var range = _.range(collection.length);
            var missing = $(range).not(skip).get();

            missing = chunk_array(missing, 2);


            $.each(missing, function () {
                fields = $("<div class='fields' />");

                createColumn(fields, collection[this[0]], "four wide field");

                if (this[1] !== undefined) {
                    createColumn(fields, collection[this[1]], "four wide field");
                };

                scrud.append(fields);
            });



            initializeAjaxRequest();
            initializeUploader();
            initializeValidators();
            setRegionalFormat();
            loadDatepicker();

            var initialValue = $(".initial.value").html();

            $("input.live").keyup(function () {
                var val = $(this).val();

                if (!val.length) {
                    $(".initial.value").html(initialValue);
                    $(".huge.header .sub.header").html("");
                    $(".live:not(input)").html("");
                } else {
                    $(".initial.value").html("");
                    $(".huge.header .sub.header").html(initialValue);

                    $(".live:not(input)").html(val);
                };
            });

            $("input.live").trigger("keyup");
        };

        function loadEdit() {
            var queryString = getQueryStringByName(window.queryStringKey || "");

            if (!queryString) {
                createForm(window.formPocoName);
                return;
            };

            function getViewForEdit(pocoName, primaryKeyValue) {
                var url = "/Services/Modules/PocoService.asmx/GetViewForEdit";
                var data = appendParameter("", "pocoName", pocoName);
                data = appendParameter(data, "primaryKeyValue", primaryKeyValue);

                data = getData(data);

                return getAjax(url, data);
            };

            var ajaxGetViewForEdit = getViewForEdit(formPocoName, queryString);

            ajaxGetViewForEdit.success(function (msg) {
                editData = JSON.parse(msg.d);
                createForm(window.formPocoName);
            });
        };

        function initializeValidators(){

            $(".dropdown input.search").blur(function(){
                $(this).parent().find("select").trigger("blur");
            });

            $(".poco.form.factory [required]:not(:disabled):not([readonly])").blur(function(){
                var el = $(this);

                var val = el.val();
                var errorMessage = el.closest(".field").find(".error-message");

                if(!errorMessage.length){
                    errorMessage = $("<span class='error-message' />"); 
                    el.closest(".field").append(errorMessage);
                };

                if(isNullOrWhiteSpace(val)){
                    isValid = false;
                    makeDirty(el);

                    el.closest(".field").find(".error-message").html(Resources.Labels.ThisFieldIsRequired());
                }else{
                    removeDirty(el);
                    el.closest(".field").find(".error-message").html("");
                };
            });
        };

        function mergeArray(array) {
            var merged = [];

            for (var i = 0; i < array.length; i++) {
                merged = merged.concat(array[i]);
            }

            return merged;
        };

        function createColumn(el, column, cssClass) {
            if (typeof (column) === "undefined") {
                return;
            };

            if(["audit_user_id", "audit_ts"].indexOf(column.ColumnName) >=0){
                return;
            };
            var value = "";

            if (window.editData) {
                value = window.editData[column.ColumnName];
            };

            var field = $("<div/>");
            field.addClass(cssClass);

            var label = $("<label/>");
            label.text(getLabel(column.ColumnName));
            label.attr("for", column.ColumnName);


            var element = getField(column.PropertyName, column.DbDataType, column.IsNullable);


            element.attr("id", column.ColumnName);

            if (column.DbDataType.indexOf("strict") > -1) {
                element.attr("data-validation", column.DbDataType);
            };

            element.attr("data-property", column.PropertyName);
            element.attr("data-type", column.DbDataType);

            if (typeof (window.live) !== "undefined") {
                if (column.PropertyName === live) {
                    element.addClass("live");
                };
            };

            if(typeof(readonlyColumns) === "undefined"){
                readonlyColumns = [];
            };

            if(readonlyColumns.indexOf(column.PropertyName) > -1){
                element.attr("readonly", "");
            };                

            if (column.Value) {
                element.attr("data-value", column.Value);
                element.val(column.Value);
            };

            if (column.IsSerial) {
                element.attr("readonly", "readonly");
            };

            if (column.IsPrimaryKey) {
                element.attr("data-primaryKey", "");
                element.removeClass();
            };

            if (column.MaxLength > 0) {
                element.attr("maxlength", column.MaxLength);
            };

            if (!column.IsNullable) {
                element.attr("required", "required");
                label.html(label.text() + "&nbsp;<span style='color:red'>*</span>");
            };

            if (value) {
                if (!element.is("select")) {
                    element.val(value);
                };
            };

            element.addClass("form-field");

            field.append(label);
            field.append(element);

            el.append(field);
        };

        //var bool = "<select class='ui dropdown'><option value='yes'>Yes</option><option value='no'>No</option>";

        function getField(propertyName, dataType, nullable) {
            if(typeof(window.keys) === "undefined"){
                window.keys = [];
            };

            var hasKey = _.findWhere(keys, { property: propertyName });

            if (hasKey) {
                return $("<select class='ui search dropdown' />");
            };

            switch (dataType) {
            case "image":
                return $("<input type='text' class='image' />");
            case "int4":
            case "int8":
            case "integer_strict":
            case "integer_strict2":
                return $("<input type='text' class='integer' />");
            case "float8":
            case "decimal":
            case "numeric":
                return $("<input type='text' class='decimal' />");
            case "money_strict2":
            case "money_strict":
                return $("<input type='text' class='currency' />");
            case "text":
                return $("<textarea />");
            case "date":
                return $("<input type='text' class='date' />");
            case "bool":
            case "boolean":
                var el = $("<select class='ui search dropdown' />");
                var option = "<option";

                if (nullable) {
                    option += " value='Select'>";
                } else {
                    option += " value=''>";
                };

                option += Resources.Titles.Select() + "</option>";
                option += "<option value='yes'>" + Resources.Titles.Yes() + "</option>";
                option += "<option value='no'>" + Resources.Titles.No() + "</option>";

                el.append(option);

                return el;
            default:
                return $("<input type='text' />");
            };
        };

        function tryParseLocalizedResource(text) {
            var localized = executeFunctionByName("Resources.Titles." + text, window);

            if (!localized) {
                localized = executeFunctionByName("Resources.ScrudResource." + text, window);
            };

            if (localized) {
                return localized;
            };

            return text;
        };

        function getLabel(columnName) {
            return tryParseLocalizedResource(columnName);
        };

    $(document).keydown(function(event){
        if (event.ctrlKey) {
            if (event.key === "Enter") {
                $("#SaveButton").trigger("click");
                return false;
            };
        };        
    })
    </script>
</div>
